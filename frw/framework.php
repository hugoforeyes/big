<?php
/**
* @version		$Id: framework.php 3 2014-12-29 10:59 Phu $
* @package		vFramework.core
* @copyright	(C) 2014 Vipcom. All rights reserved.
* @license		Commercial
*/
defined('V_LIFE')or die('v');define('V_VS',(isset($_COOKIE['webadmin'])&&$_COOKIE['webadmin'])?1:0);include PATH_CORE.DS.'bootstrap.php';if(V_LIFE==2&&!defined('V_SITE')){$t=strip_tags($_SERVER['HTTP_HOST']);$db->query('SELECT id, prop FROM #__site WHERE domain="'.$t.'"',1);if(!$db->affected_rows())$db->query('SELECT id, prop FROM #__site ORDER BY def DESC',1);$t=$db->fetch_row();$t['prop']=($t['prop'])?vRegistry::parse($t['prop']):array();define('V_SITE',$t['id']);$cfg=array_merge($cfg,$t['prop']);unset($t);}define('URL_THEME',URL_THEMES.$cfg['theme'].'/');define('PATH_THEME',PATH_THEMES.DS.$cfg['theme']);$tpl=vTemplate::instance();if($cfg['sef'])vSEF::parse();else $map=new vSitemap(true);if(isset($map->m['id'])&&$map->m['id'])$mem=vMember::instance();$alt['id']=($cfg['sef'])?vRequest::cmd(VAR_ID):vRequest::int(VAR_ID);$alt['page']=vRequest::string(VAR_PAGE,'/');$alt['section']=vRequest::string(VAR_SECTION);$alt['task']=vRequest::cmd(VAR_TASK);$alt['keyword']=str_replace(array('"',"'"),'',vRequest::string(VAR_KEYWORD));$alt['paging']=vRequest::int(VAR_PAGING,1);if($alt['paging']<1)$alt['paging']=1;$alt['lang']=vRequest::cmd(VAR_LANG,$cfg['lang']);if($cfg['lang']<>$alt['lang'])$map=new vSitemap(true,$alt['lang']);define('PATH_LANG',PATH_LANGS.DS.$alt['lang']);$tpl->lang('general');$tpl->vars(array('SITE'=>$cfg['site'],'PAGE'=>($alt['page']=='/')?'homepage':$alt['page'],'LANG'=>$alt['lang'],'LANG_ISO'=>$cfg['language'][$alt['lang']][0],'LANG_DIR'=>$cfg['language'][$alt['lang']][2]?'rtl':'ltr','URL_BASE'=>URL_BASE.(($cfg['langs']>1&&$cfg['lang']!=$alt['lang'])?VAR_INDEX.'?'.VAR_LANG.'='.$alt['lang']:''),'URL_UPLOAD'=>URL_UPLOAD,'URL_THEME'=>URL_THEME,'URL_JS'=>URL_JS,));if(isset($cfg['theme_style'])&&$cfg['theme_style'])vPage::head(URL_THEME.$cfg['theme_style'].'.css','css');if(V_VS)vPage::head(URL_JS.'webadmin/style.css','css');if($alt['page']=='null'&&$alt['section']&&is_file(PATH_CTYPE.DS.'blk_'.$alt['section'].DS.'blk_'.$alt['section'].'.php')){$cfg['~ajax']=true;$cfg['path_working']=PATH_CTYPE.DS.'blk_'.$alt['section'];include($cfg['path_working'].DS.'blk_'.$alt['section'].'.php');$b=null;if($i=vRequest::int(VAR_BLOCK)){$sql='SELECT id, title, ctype, pos, prop FROM #__blocks WHERE enabled=1'.(($cfg['langs']>1)?' AND (lang="" OR lang="'.$alt['lang'].'")':'').' AND id='.$i;if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);if($db->affected_rows()){$b=$db->fetch_row();$b['prop']=vRegistry::parse($b['prop']);}}call_user_func('blk_'.$alt['section'],$b);}else if(isset($map->r[$alt['page']])){if(vRequest::issubmit('ajax'))$cfg['~ajax']=true;if((!$map->m&&$map->r[$alt['page']]['auth'])||(isset($map->m['id'])&&$map->m['id']&&$map->r[$alt['page']]['auth']&&$mem->state!='active')){vPage::redirect(URL_BASE.VAR_INDEX.'?'.(($cfg['langs']>1&&$alt['lang']!=$cfg['lang'])?VAR_LANG.'='.$alt['lang'].'&':'').VAR_PAGE.'='.$map->m['alias']);}if($map->r[$alt['page']]['ctype']=='alias'){$t=$map->r[$alt['page']]['prop']['url'];if(substr($t,0,7)!='http://'){$a=(($cfg['langs']>1&&$cfg['lang']!=$alt['lang'])?VAR_LANG.'='.$alt['lang'].'&amp;':'');if($t{0}=='?')$t=URL_BASE.VAR_INDEX.'?'.$a.substr($t,1);else if($t{0}=='/')$t=URL_BASE.(($t=='/')?(($cfg['langs']>1&&$cfg['lang']!=$alt['lang'])?VAR_INDEX.'?'.VAR_LANG.'='.$alt['lang']:''):substr($t,1));else $t=URL_BASE.VAR_INDEX.'?'.$a.VAR_PAGE.'='.((is_numeric($t)&&isset($map->i[$t]))?$map->i[$t]['alias']:$t);}vPage::redirect($t);}else if($map->r[$alt['page']]['ctype']==''||$map->r[$alt['page']]['ctype']=='null'){if($alt['id']||$alt['section']||$alt['paging']!=1||$alt['task']||$alt['keyword'])vPage::http404();}else{$cfg['path_working']=PATH_CTYPE.DS.$map->r[$alt['page']]['ctype'];define('PATH_WORKING',$cfg['path_working']);include(PATH_WORKING.DS.$map->r[$alt['page']]['ctype'].'.php');if(isset($cfg['~ajax'])&&$cfg['~ajax'])$tpl->display('body',false,true,($cfg['sef'])?true:false,false);else{$t=$tpl->display('body',true);if(!$cfg['debug']&&!$t&&!isset($cfg['~ajax']))vPage::http404();$tpl->_var('CTN',(V_VS?'<div class="v_webadmin"><div class="v_ctrl"><a href="'.URL_CP.'?m=cp.sitemap&t=edit&id='.$map->r[$alt['page']]['id'].'" title="'.$tpl->_('Edit').'"></a></div>':'').$t.(V_VS?'</div>':''));unset($t);}}if(!isset($cfg['~ajax'])){if(!isset($cfg['~seo'])||!$cfg['~seo']){$t=vRegistry::parse($map->r[$alt['page']]['meta']);if(isset($t['d'])&&$t['d'])vPage::head($t['d'],'description');if(isset($t['k'])&&$t['k'])vPage::head($t['k'],'keywords');vPage::head((isset($t['t'])&&$t['t'])?$t['t']:$map->r[$alt['page']]['title'],'title');unset($t);}$blk=new vBlocks($map->r[$alt['page']]['id']);for($i=0;$i<$blk->c;$i++){if((!$map->m&&$blk->d[$i]['auth']==1)||(isset($map->m['id'])&&$map->m['id']&&(($blk->d[$i]['auth']==1&&$mem->state!='active')||($blk->d[$i]['auth']==-1&&$mem->state=='active'))))continue;if(isset($blk->d[$i]['prop']['vie'])&&$blk->d[$i]['prop']['vie']&&(($blk->d[$i]['prop']['vie']==2&&$alt['id'])||($blk->d[$i]['prop']['vie']==1&&!$alt['id'])))continue;$tpl->reset_theme('block');$tpl->reset_block('block');$tpl->reset_block('blk');$tpl->reset_block('ajax');switch($blk->d[$i]['ctype']){case 'html':case 'code':$t=str_replace(array('{LANG}','{PAGE}','{URL_JS}','{URL_THEME}','{URL_BASE}','{URL_UPLOAD}'),array($alt['lang'],($alt['page']=='/')?'homepage':$alt['page'],URL_JS,URL_THEME,URL_BASE,URL_UPLOAD),$blk->d[$i]['prop']['htm']);if($blk->d[$i]['ctype']=='html')$t='<div '.$tpl->css($blk->d[$i]['prop']['css'],'.vf_block').'>'.(($blk->d[$i]['title']{0}=='~')?'':'<'.$blk->d[$i]['prop']['tag'].' class="vf_tit">'.$blk->d[$i]['title'].'</'.$blk->d[$i]['prop']['tag'].'>').$t.'</div>';else$t=str_replace('&amp;','&',$t);$tpl->_var($blk->d[$i]['pos'],((V_VS&&$blk->d[$i]['pos']!='INC')?'<div class="v_webadmin"><div class="v_edit"><a href="'.URL_CP.'?m=cp.blocks&t=edit&id='.$blk->d[$i]['id'].'" title="'.$tpl->_('Edit').'"></a></div>':'').$t.((V_VS&&$blk->d[$i]['pos']!='INC')?'</div>':''),true);break;case 'menu':$tpl->_var($blk->d[$i]['pos'],(V_VS?'<div class="v_webadmin"><div class="v_ctrl"><a href="'.URL_CP.'?m=cp.blocks&t=edit&id='.$blk->d[$i]['id'].'" title="'.$tpl->_('Edit').'"></a></div>':'').$map->menu($blk->d[$i]['title'],$blk->d[$i]['prop'],$alt['page']).(V_VS?'</div>':''),true);break;default:$cfg['path_working']=PATH_CTYPE.DS.'blk_'.$blk->d[$i]['ctype'];include_once($cfg['path_working'].DS.'blk_'.$blk->d[$i]['ctype'].'.php');call_user_func('blk_'.$blk->d[$i]['ctype'],$blk->d[$i]);$tpl->_var($blk->d[$i]['pos'],(V_VS?'<div class="v_webadmin"><div class="v_ctrl"><a href="'.URL_CP.'?m=cp.blocks&t=edit&id='.$blk->d[$i]['id'].'" title="'.$tpl->_('Edit').'"></a></div>':'').$tpl->display('block',true).(V_VS?'</div>':''),true);}}vPage::head('<meta name="generator" content="vFramework '.$cfg['ver'].' (http://www.vipcom.vn)" />');$tpl->root(PATH_THEMES,$cfg['theme']);$tpl->theme('page',$cfg['theme_page']);$tpl->display('page',false,true,($cfg['sef'])?true:false,false);}}else vPage::http404();vPage::finish();