<?php
/**
* @version		$Id: file.php 1 2011-04-25 11:31 phu $
* @package		vFramework.core.file
* @copyright	(C) 2011 Vipcom. All rights reserved.
* @license		Commercial
*/
defined('V_LIFE')or die('v');$file=vFile::instance();
class vFile{private static $_f;var $c;var $m='';var $r=0;var $error;public static function instance(){if(is_null(self::$_f))self::$_f=new self();return self::$_f;}function __construct(){global $cfg;if($cfg['ftp']['enable']){if(@extension_loaded('ftp'))$this->m='ftp';$this->r=($cfg['ftp']['host']=='127.0.0.1'||$cfg['ftp']['host']=='localhost')?0:1;}}function connect(){global $cfg;if($this->m=='ftp'){$this->c=ftp_connect($cfg['ftp']['host'],$cfg['ftp']['port']);if(!$this->c)vPage::finish('Unable connect to FTP server!');ftp_pasv($this->c,(isset($cfg['ftp']['mode'])&&$cfg['ftp']['mode'])?true:false);if(!ftp_login($this->c,$cfg['ftp']['user'],$cfg['ftp']['pass']))vPage::finish('Unable login to FTP server!');if($cfg['ftp']['root']&&!$this->chdir($cfg['ftp']['root']))vPage::finish('Unable login to FTP server!');}}function close(){if($this->c&&$this->m='ftp')ftp_close($this->c);}function realpath($f){if(substr($f,0,4)=='http')return $f;else return str_replace('/',DS,(URL_BASE=='')?PATH_ROOT.$f:str_replace(URL_BASE,PATH_ROOT,$f));}function ext($f){return strtolower(substr(strrchr($f,'.'),1));}function name($f){return preg_replace('#\.[^.]*$#','',$f);}function exist($f){$f=str_replace(array('../','./'),'',$f);if($f&&$f{0}==DS)$f=substr($f,1);if($f&&substr($f,-1)==DS)$f=substr($f,0,-1);if($this->m=='ftp'&&$this->r){if(!$this->c)$this->connect();return false;}return file_exists(PATH_UPLOAD.DS.$f);}function mkdir($p,$m=0777){$p=vFilter::folder($p);if($this->exist($p))return false;if($this->m=='ftp'){if(!$this->c)$this->connect();if(ftp_mkdir($this->c,$p)===false)return false;return $p;}$o=@ umask(0);if(!$ret=@mkdir(PATH_UPLOAD.DS.$p)){@ umask($o);return false;}@ umask($o);chmod(PATH_UPLOAD.DS.$p,0777);return $p;}function rmdir($p){$p=str_replace(array('../','./'),'',$p);if($p&&$p{0}==DS)$p=substr($p,1);if($p&&substr($p,-1)==DS)$p=substr($p,0,-1);if($this->m=='ftp'){if(!$this->c)$this->connect();return ftp_rmdir($this->c,$p);}else return rmdir(PATH_UPLOAD.DS.$p);}function upload($src,$target,$chunks=0,$chunk=0,$overwrite=false){if($this->m AND !$this->c)$this->connect();$target_file=basename($target);if($target_file=='')$target_file=basename($src);$target=dirname($target);$target=vFilter::folder($target);if($target)$target=$target.'/';$r=1;if(!$this->exist($target))$this->mkdir($target);$in=fopen($src,"r");if(!$in)return false;if($chunks<2){$target_file=$this->_u($target_file,$target,$src);if($this->m=='ftp'){$r=ftp_fput($this->c,$target_file,$in,FTP_BINARY);}else{$out=fopen(PATH_UPLOAD.DS.$target.$target_file,"wb");if($out){while($buff=fread($in,4096))fwrite($out,$buff);}else $r=0;fclose($out);}}else{$out=fopen((($this->m=='ftp')?PATH_TMP.DS:PATH_UPLOAD.DS.$target.'~').$target_file,$chunk==0?"wb":"ab");while($buff=fread($in,4096))fwrite($out,$buff);fclose($out);if($chunks==$chunk + 1){$target_file0=$target_file;$target_file=$this->_u($target_file0,$target,($this->m=='ftp'?PATH_TMP.DS:PATH_UPLOAD.DS.$target.'~').$target_file0);if($this->m=='ftp'){$t=fopen(PATH_TMP.DS.$target_file0,"r");$r=ftp_fput($this->c,$target_file,$t,FTP_BINARY);fclose($t);unlink(PATH_TMP.DS.$target_file0);}else{rename(PATH_UPLOAD.DS.$target.'~'.$target_file0,PATH_UPLOAD.DS.$target.$target_file);}}}fclose($in);$this->error='';return($r)?$target.$target_file:false;}function delete($f){$f=str_replace(array('../','./'),'',urldecode($f));if($f&&$f{0}==DS)$f=substr($f,1);if($f&&substr($f,-1)==DS)$f=substr($f,0,-1);if($this->m=='ftp'){if(!$this->c)$this->connect();return ftp_delete($this->c,$f);}@chmod(PATH_UPLOAD.DS.$f,0777);return @unlink(PATH_UPLOAD.DS.$f);}function copy($s,$d,$o=false){$s=str_replace(array('../','./'),'',urldecode($s));$d=str_replace(array('../','./'),'',urldecode($d));if($d=='')return false;if($o===false){$f=dirname($d);if($f=='.')$f='';else $f.='/';$d=basename($d);$e=$this->ext($d);$n=$this->name($d);$i=1;while($this->exist($f.$d)){$d=$n.'_'.$i.'.'.$e;$i++;}$d=$f.$d;}if($this->m=='ftp'){}return copy(PATH_UPLOAD.DS.$s,PATH_UPLOAD.DS.$d)?$d:false;}function rename($o,$n){$o=str_replace(array('../','./','\\'),array('','','/'),$o);if($o&&$o{0}=='/')$o=substr($o,1);if($o&&substr($o,-1)=='/')$o=substr($o,0,-1);if($o&&$n){$p='/';if(strrpos($o,'/')){$p=explode('/',$o);$o=array_pop($p);if($p)$p='/'.implode('/',$p).'/';}if($this->exist($p.$n))return 0;if($this->m=='ftp'){$this->chdir($p);ftp_rename($this->c,$o,$n);}else return rename(PATH_UPLOAD.$p.$o,PATH_UPLOAD.$p.$n);}return 0;}function ls($dir='',$raw=false){$dir=str_replace(array('../','./'),'',urldecode($dir));if($dir&&$dir{0}==DS)$dir=substr($dir,1);$d=array();$this->error='';if($dir=='~'){return $d;}if($this->m=='ftp'&&$this->r){if(!$this->c)$this->connect();if($raw>0){foreach(ftp_rawlist($this->c,$dir)as $k=>$v){$v=preg_split('/[\s]+/',$v,9);if($v[8]=='.'||$v[8]=='..'||$v[8]=='~')continue;$d[$k]=$v[8];$r['folder'][$k]=$v[0]{0}=='d';if($raw>1){$r['size'][$k]=$v[4];$r['date'][$k]=strtotime($v[6].' '.$v[5].' '.$v[7]);$r['owner'][$k]=$v[3];$r['chmode'][$k]=$v[0];}}$this->error=$r;}else{$d=ftp_nlist($this->c,$dir);unset($d[array_search('..',$d)]);unset($d[array_search('.',$d)]);unset($d[array_search('~',$d)]);}}else{if(file_exists(PATH_UPLOAD.DS.$dir)){if($dir!=''&&substr($dir,-1)!=DS)$dir=$dir.DS;$d=scandir(PATH_UPLOAD.DS.$dir);unset($d[array_search('..',$d)]);unset($d[array_search('.',$d)]);unset($d[array_search('~',$d)]);natcasesort($d);$r=array();if($raw>0){foreach($d as $k=>$v){$r['folder'][$k]=(is_dir(PATH_UPLOAD.DS.$dir.$v))?true:false;}if($raw>1){foreach($d as $k=>$v){if(!$r['folder'][$k]){$t=$this->stat($dir.DS.$v);$r['size'][$k]=$t['size'];$r['date'][$k]=$t['date'];$r['owner'][$k]=$t['owner'];$r['chmode'][$k]=$t['chmode'];}}}}$this->error=$r;}}return $d;}function stat($f){$r=array();if($this->m=='ftp'&&$this->r){}else{$t=stat(PATH_UPLOAD.DS.$f);$r['size']=$t['size'];$r['date']=$t['mtime'];$r['owner']=$t['uid'];$r['chmode']=$t['mode'];}return $r;}function resize($f,$w=0,$h=0){if($w||$h){$e=$this->ext($f);if($e=='png')$s=imagecreatefrompng(PATH_UPLOAD.DS.$f);else if($e=='gif')$s=imagecreatefromgif(PATH_UPLOAD.DS.$f);else{$e='jpeg';$s=imagecreatefromjpeg(PATH_UPLOAD.DS.$f);}if($s){$x=imageSX($s);$y=imageSY($s);if($w==0){$w=$x*$h/$y;}else if($h==0){$h=$y*$w/$x;}else{if($x>$w||$y>$h){$i=$w/$x;$j=$h/$y;if($i>$j){$w=$x*$j;$h=$y*$j;}else{$w=$x*$i;$h=$y*$i;}}else{$w=0;$h=0;}}if($w&&$h){$d=ImageCreateTrueColor($w,$h);imagecopyresampled($d,$s,0,0,0,0,$w,$h,$x,$y);if($this->m=='ftp')$i='';else $i=PATH_UPLOAD.DS.$f;if($e=='png')imagepng($d,$i);if($e=='gif')imagegif($d,$i);else imagejpeg($d,$i);imagedestroy($d);if($this->m=='ftp'){}}imagedestroy($s);return 1;}}return 0;}public function crop($f,$w=0,$h=0){}public function chdir($d=''){if($d&&$d!=='/'){if(substr($d,-1,1)=='/')$d=substr($d,0,-1);}if($this->m=='ftp')return ftp_chdir($this->c,$d);}protected function _u($f,$d,$s=''){$f=vFilter::file($f);if($f=='')return false;$e=$this->ext($f);$n=$this->name($f);global $cfg;if(isset($cfg['file']['sfn'])&&$cfg['file']['sfn']&&$s&&vFilter::file($f,'image')){if($i=getimagesize($s)){$n=preg_replace('/(\d+)x(\d+)/','',$n);$e=$i[0].'x'.$i[1].'.'.$e;$f=$n.'.'.$e;}}$i=1;while($this->exist($d.$f)){$f=$n.'_'.$i.'.'.$e;$i++;}return $f;}}