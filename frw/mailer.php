<?php
/**
 * @version		$Id: mailer.php 3 2013-09-27 16:30 phu $
 * @package		vFramework.core.mailer
 * @copyright	(C) 2012 Vipcom. All rights reserved.
 * @license		Commercial
 */
defined('V_LIFE')or die('v');
class vMailer{protected static $m;protected $d;protected $c=null;public static function instance(){if(is_null(self::$m)){self::$m=new self();}return self::$m;}public function __construct(){$this->reset();}public function reset(){global $cfg;$this->d=array('from'=>array($cfg['email'],$cfg['site']),'to'=>array(),'cc'=>array(),'bcc'=>array(),'replyto'=>array(),'returnpath'=>'','charset'=>'utf-8','subject'=>'','message'=>'','files'=>array(),'priority'=>3,'headers'=>array(),'body'=>array(),'extra_headers'=>array(),'htmltype'=>1,);return $this;}public function to($e,$n=''){$e=trim($e);if($e){$this->d['to'][]=array($e,trim($n));}return $this;}public function cc($e,$n=''){$e=trim($e);if($e){$this->d['cc'][]=array($e,trim($n));}return $this;}public function bcc($e,$n=''){$e=trim($e);if($e){$this->d['bcc'][]=array($e,trim($n));}return $this;}public function replyto($e,$n=''){$e=trim($e);if($e){$this->d['replyto']=array($e,trim($n));}return $this;}public function returnpath($e){$this->d['returnpath']=trim($e);return $this;}public function from($e,$n=''){$e=trim($e);if($e){$this->d['from']=array($e,trim($n));}return $this;}public function subject($s=''){$this->d['subject']=$this->b64(trim(preg_replace('#[\n\r]+#s','',trim($s))));return $this;}public function message($s=''){$this->d['message']=str_replace(array("\r\n","\r"),"\n",vFilter::html($s));return $this;}public function extra_headers($s){$this->d['extra_headers'][].=trim($s);return $this;}public function charset($s='utf-8'){$this->d['charset']=trim($s);return $this;}public function htmltype($t=1){$this->d['htmltype']=$t?1:0;return $this;}public function priority($p=3){$p=intval($p);$this->d['priority']=($p<1||$p>5)?3:$p;return $this;}public function attachment($p,$f='',$t='application/octet-stream',$c=''){if(!$f&&$p){$f=basename($p);}if($f&&($p||$c)){$this->d['files'][]=array($p,$f,$t,$c);}return $this;}public function send(){global $cfg;if(!$this->d['to']&&!$this->d['cc']&&!$this->d['bcc']){return;}if(!$this->d['returnpath']){$this->d['returnpath']=$this->d['from'][0];}if(!$this->d['replyto']){$this->d['replyto']=$this->d['from'];}$t=md5(uniqid(time()));$b1=($this->d['htmltype'])?'b1_'.$t:'';$b2=($this->d['files'])?'b2_'.$t:'';$d=& $this->d['headers'];$d=array();$d[]='Date: '.gmdate('r');if($cfg['mailer']&&$cfg['mailer']!='mail'){$d[]='To: '.(!$this->d['to']?'undisclosed-recipients:;':$this->email($this->d['to']));}$d[]='From: '.$this->email($this->d['from']);if($this->d['cc']){$d[]='Cc: '.$this->email($this->d['cc']);}if($this->d['bcc']){$d[]='Bcc: '.$this->email($this->d['bcc']);}$d[]='Reply-To: '.$this->email($this->d['replyto']);if($cfg['mailer']&&$cfg['mailer']!='mail'){$d[]='Subject: '.$this->d['subject'];}$d[]='Message-ID: <'.$t.'@'.$_SERVER['HTTP_HOST'].'>';$d[]='X-Priority: '.$this->d['priority'];$d[]='X-Mailer: vFramework';$d[]='MIME-Version: 1.0';if($b1||$b2){$d[]='Content-Type: multipart/'.($b2?'mixed':'alternative').';';$d[]="\t".'boundary="'.($b2?$b2:$b1).'"';}else{$d[]='Content-Type: '.(($this->d['htmltype']?'text/html':'text/plain').'; charset='.$this->d['charset']);}$d[]='Content-Transfer-Encoding: 8bit';$d=array_merge($d,$this->d['extra_headers']);$d[]='';$d=implode("\n",$d);$d=& $this->d['body'];$d=array();if($b2){$d[]='--'.$b2;}if($b1){if($b2){$d[]='Content-Type: multipart/alternative;';$d[]="\t".'boundary="'.$b1.'"';$d[]='';}$t=trim(strip_tags(str_replace(array('<td>','</tr>','</p>','<br>','<br />'),array("\t","\n"),$this->d['message'])));$d[]='--'.$b1;if($this->c8bit($t)){$d[]='Content-Type: text/plain; charset='.$this->d['charset'];$d[]='Content-Transfer-Encoding: 8bit';}else{$d[]='Content-Type: text/plain; charset=us-ascii';}$d[]='';$d[]=$t;$d[]='';$d[]='';$d[]='--'.$b1;if($this->c8bit($this->d['message'])){$d[]='Content-Type: text/html; charset='.$this->d['charset'];$d[]='Content-Transfer-Encoding: 8bit';}else{$d[]='Content-Type: text/html; charset=us-ascii';}$d[]='';}$d[]=$this->d['message'];$d[]='';$d[]='';$d[]='';if($b1){$d[]='--'.$b1.'--';}if($b2){foreach($this->d['files'] as $f){if($f[0])$f[3]=file_get_contents($f[0]);if($f[3]){$d[]='';$d[]='--'.$b2;$d[]='Content-Type: '.$f[2].'; name="'.$f[1].'"';$d[]='Content-Transfer-Encoding: base64';$d[]='Content-Disposition: attachment; filename="'.$f[1].'"';$d[]='';$d[]=chunk_split(base64_encode($f[3]),76,"\n");}}$d[]='';$d[]='';$d[]='--'.$b2.'--';}$d=implode("\n",$d);if($cfg['mailer']=='smtp'){$d=$this->smtp();if($this->c){fclose($this->c);$this->c=null;}}else if(empty($cfg['mailer'])||$cfg['mailer']=='mail'){$d=$this->php();}else{$d=$this->sendmail();}if($cfg['debug']){vPage::debug($d?'Sent successfully!':'Failed!!!');}return $d;}protected function email($e){$s=array();if(is_array($e)){if(is_array($e[0])){foreach($e as $v)$s[]=($v[1])?$this->b64($v[1]).' <'.$v[0].'>':$v[0];}else{$s[]=($e[1])?$this->b64($e[1]).' <'.$e[0].'>':$e[0];}}else{$s[]=$e;}return implode(', ',$s);}protected function php(){if(ini_get('safe_mode')){return mail($this->email($this->d['to']),$this->d['subject'],$this->d['body'],$this->d['headers']);}else{return mail($this->email($this->d['to']),$this->d['subject'],$this->d['body'],$this->d['headers'],'-f'.$this->d['returnpath']);}}protected function sendmail(){global $cfg;if(!@$mail=popen(escapeshellcmd($cfg['mailer']).' -oi -f '.escapeshellarg($this->d['returnpath']).' -t','w')){if($cfg['debug']){vPage::debug('Can not open '.$cfg['mailer']);}return 0;}fputs($mail,$this->d['headers']);fputs($mail,$this->d['body']);$r=pclose($mail);if($cfg['debug']){vPage::debug($r);}return($r==0)?1:0;}protected function smtp(){global $cfg;$h=$cfg['smtp'];$s='';$a=strtolower(substr($h['host'],0,3));if($a=='ssl'||$a=='tls'){$s=$a;$h['host']=substr($h['host'],6);}$this->c=fsockopen((($s=='ssl')?'ssl://':'').$h['host'],(isset($h['port'])&&$h['port'])?$h['port']:25,$e1,$e2,30);if(!$this->c){if($cfg['debug']){vPage::debug('Could not connect to SMTP host ('.$h['host'].") : $e1 : $e2",E_USER_ERROR);}return 0;}if(substr(PHP_OS,0,3)!="WIN"){socket_set_timeout($this->c,30,0);}$r=$this->smtp_read();if($cfg['debug']){vPage::debug($r);}if(!$this->smtp_write('EHLO '.$h['host'],250)){if(!$this->smtp_write('HELO '.$h['host'],250)){return 0;}}if($s=='tls'){$this->smtp_write('STARTTLS',220);if(!stream_socket_enable_crypto($this->c,true,STREAM_CRYPTO_METHOD_TLS_CLIENT)){return 0;}if(!$this->smtp_write('EHLO '.$h['host'],250)||!$this->smtp_write('HELO '.$h['host'],250)){return 0;}}if($h['user']||$h['pass']){$this->smtp_write('AUTH LOGIN',334);if(!$this->smtp_write(base64_encode($h['user']),334)){return 0;}if(!$this->smtp_write(base64_encode($h['pass']),235)){return 0;}}$this->smtp_write('MAIL FROM:<'.$h['user'].'>',250);foreach($this->d['to'] as $v){$this->smtp_write('RCPT TO:<'.$v[0].'>',250,251);}foreach($this->d['cc'] as $v){$this->smtp_write('RCPT TO:<'.$v[0].'>',250,251);}foreach($this->d['bcc'] as $v){$this->smtp_write('RCPT TO:<'.$v[0].'>',250,251);}if(!$this->smtp_write('DATA',354)){return 0;}$d=& $this->d['headers'];foreach(explode("\n",$d)as $l){$this->smtp_write($this->line($l,"\t"),false);}$d=& $this->d['body'];foreach(explode("\n",$d)as $l){$this->smtp_write($this->line($l),false);}$this->smtp_write("\r\n.",250);$this->smtp_write('QUIT',221);return 1;}protected function line($s,$a='',$m=998){$r=null;while(strlen($s)>$m){$p=strrpos(substr($s,0,$m),' ');if(!$p){$p=$m - 1;}$r[]=(($s{0}=='.')?'.':'').substr($s,0,$p);$s=$a.substr($s,$p);}$r[]=(($s&&$s{0}=='.')?'.':'').$s;return $r;}protected function smtp_write($c,$e=0,$f=0){global $cfg;if(is_array($c)){foreach($c as $l){fputs($this->c,$l."\r\n");}}else{fputs($this->c,$c."\r\n");}if($e!==false){$r=$this->smtp_read();if($cfg['debug']){vPage::debug($r);}return(($e&&$e!=substr($r,0,3))||($f&&$f!=substr($r,0,3)))?0:1;}}protected function smtp_read(){$d='';while(!feof($this->c)){$s=@fgets($this->c,515);$d.=$s;if(substr($s,3,1)==' '){break;}}return $d;}protected function qp($d){if(function_exists('quoted_printable_encode')){return quoted_printable_encode($d);}$h=array('0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F');$l=preg_split('/(?:\r\n|\r|\n)/',$d);$d='';while(list(,$v)=each($l)){$n=strlen($v);$new='';for($i=0;$i<$n;$i++){$c=substr($v,$i,1);$dec=ord($c);if(($i==0)&&($dec==46)){$c='=2E';}if($dec==32){if($i==($n - 1)){$c='=20';}}elseif(($dec==61)||($dec<32)||($dec>126)){$h2=floor($dec/16);$h1=floor($dec%16);$c='='.$h[$h2].$h[$h1];}if((strlen($new)+ strlen($c))>=76){$d.=$new."=\r\n";$new='';if($dec==46){$c='=2E';}}$new.=$c;}$d.=$new."\n";}return $d;}protected function b64($d){if($d&&strlen($d)>strlen(utf8_decode($d))){$d=base64_encode($d);$d='=?'.$this->d['charset'].'?B?'.((strlen($d)>76)?substr(chunk_split($d,76 - 7 - strlen($this->d['charset']),"?=\n\t=?".$this->d['charset'].'?B?'),0,-strlen("?=\n\t=?".$this->d['charset'].'?B?')):$d).'?=';}return $d;}public function c8bit($s){return (bool)preg_match('/[\x80-\xFF]/',$s);}}