<?php
/**
 * @version		$Id: blk_banner.php 3 2013-05-24 14:49 phu $
 * @package		vFramework.block.banner
 * @copyright	(C) 2012 Vipcom. All rights reserved.
 * @license		Commercial
 */
defined('V_LIFE')or die('v');function blk_banner($p=''){global $tpl,$db,$alt,$cfg;$o=& $p['prop'];$tpl->reset_theme('block');$tpl->theme('block',(isset($o['tpl'])&&$o['tpl'])?$o['tpl']:'blk_banner');$tpl->reset_block('blk');$tpl->reset_block('ajax');if(isset($cfg['~ajax'])&&$cfg['~ajax']){if($alt['id']){$sql='SELECT clickurl FROM #__banners WHERE id='.$alt['id'];if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);if($db->affected_rows()){$t=$db->fetch_field('clickurl');$sql='UPDATE #__banners SET clicks=clicks + 1 WHERE id='.$alt['id'];if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);}vPage::redirect((isset($t)&&$t)?$t:URL_BASE);}else{blk_banner_content($p,1);$tpl->display('block',0,1,1,1);}die;}if(isset($o['ajx'])&&$o['ajx']){$tpl->block('ajax',array('ID'=>'vf_ajax_'.$p['id'],'URL'=>URL_BASE.VAR_INDEX.'?'.VAR_PAGE.'=null&'.VAR_SECTION.'=banner&'.VAR_BLOCK.'='.$p["id"],'TIME'=>$o['ajx']*1000,));}blk_banner_content($p);}function blk_banner_content($p,$j=0){global $tpl,$db,$alt,$cfg;$o=& $p['prop'];$tpl->block('blk',array('CSS'=>$tpl->css($o['css'],'.vf_block'),'TITLE'=>($p['title']{0}=='~')?'':$p['title'],'TAG'=>(isset($o['tag'])&&$o['tag'])?$o['tag']:'h3','ID'=>($j)?'':'vf_ajax_'.$p['id'],));$id=intval($o['src']);if($id){$sql='SELECT id, title, tip, content, imageurl, width, height, clickurl FROM #__banners WHERE pid='.$id.' AND published>0 AND published<'.time().' ORDER BY '.(($o['typ']=='rnd')?'rand()':'ordering ASC');if(!$db->query($sql,$o['num']))trigger_error($db->error(),E_USER_ERROR);if($db->affected_rows()){$d=$db->fetch();$i=array();foreach($d as $k=>$v){$tpl->block('blk.row',array('ID'=>$v['id'],'TIP'=>$v['tip'],'HREF'=>($v['clickurl'])?' href="'.((isset($o['cli'])&&$o['cli'])?VAR_INDEX.'?'.VAR_PAGE.'=null&'.VAR_SECTION.'=banner&'.VAR_ID.'='.$v['id']:$v['clickurl']).'"':'','BANNER'=>vForm::media($v['imageurl'],array('width'=>$v['width'],'height'=>$v['height'])),'IMAGE' => URL_UPLOAD.$v['imageurl'],'CONTENT'=>(isset($o['ctn'])&&$o['ctn'])?$v['content']:'','TITLE'=>(isset($o['tit'])&&$o['tit'])?$v['title']:'',));$i[]=$v['id'];}if(isset($o['imp'])&&$o['imp']){$sql='UPDATE #__banners SET impressions=impressions + 1 WHERE id IN ('.implode(',',$i).')';if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);}unset($i);}}}