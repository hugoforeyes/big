<?php
/**
 * @version		$Id: search.php 3 2013-09-04 14:19 phu $
 * @package		vFramework.search
 * @copyright	(C) 2011 Vipcom. All rights reserved.
 * @license		Commercial
 */
defined('V_LIFE')or die('v');$alt['module']=&$map->r[$alt['page']];$o=&$map->r[$alt['page']]['prop'];$u=URL_BASE.VAR_INDEX.'?'.(($cfg['langs']>1&&$alt['lang']!=$cfg['lang'])?VAR_LANG.'='.$alt['lang'].'&':'').VAR_PAGE.'=';$tpl->theme('body','search');$tpl->vars(array('KEYWORD'=>$alt['keyword'],'TITLE'=>$map->r[$alt['page']]['title'],'CSS'=>$tpl->css($o['css'],'.vf_article'),));$tpl->reset_block('frm');if(isset($o['frm'])&&$o['frm'])$tpl->block('frm',array('VAR_KEYWORD'=>VAR_KEYWORD,'METHOD'=>$o['typ'],'S_SEARCH'=>$u.$alt['page'],));if($alt['keyword']){if(is_array($o['src']))$o['src']=implode(',',$o['src']);$f=' WHERE'.(($o['src'])?' cid IN ('.$o['src'].') AND':'').' published>0 AND published<'.time();$f.=($cfg['langs']>1)?(' AND ('.(($alt['lang']==$cfg['lang'])?'lang="" OR ':'').'lang="'.$alt['lang'].'")'):'';$f.=' AND (title LIKE "%'.$alt['keyword'].'%" OR content LIKE "%'.$alt['keyword'].'%")';$sql='SELECT '.(($cfg['sef'])?'alias as id':'id').', cid, title, alias, pic_thumb, preview, published FROM #__article'.$f.' ORDER BY hits DESC';if(!$db->query($sql,$cfg['paging'],($alt['paging']-1)*$cfg['paging']))trigger_error($db->error(),E_USER_ERROR);if($db->affected_rows()){$d=$db->fetch();foreach($d as $k=>$v){$tpl->block('row',array('TITLE'=>$v['title'],'PREVIEW'=>($v['preview'])?$v['preview']:'','PIC_THUMB'=>($v['pic_thumb'])?'<img src="'.URL_UPLOAD.'/'.$v['pic_thumb'].'" border="0" />':'','DATE'=>vTime::format($cfg['date']['time'],$v['published']),'U_VIEW'=>$u.$map->i[$v['cid']]['alias'].(($map->i[$v['cid']]['prop']['typ']==1)?'':'&'.VAR_ID.'='.$v['id']),));}}$sql='SELECT count(id) as total FROM #__article'.$f;if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);if($total=$db->fetch_field('total')){if($alt['paging']<1)$alt['paging']=1;if($alt['paging']>$i=ceil($total/$cfg['paging']))$alt['paging']=$i;}$tpl->vars(array('PAGING'=>vPage::paging($u.$alt['page'].'&'.VAR_KEYWORD.'='.$alt['keyword'],$total,$cfg['paging'],$alt['paging']),));}