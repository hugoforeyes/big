<?php
/**
* @version		$Id: view.php 3 2012-09-10 13:39 phu $
* @package		vFramework.cp.mvc
* @copyright	(C) 2012 Vipcom. All rights reserved.
* @license		Commercial
*/
defined('V_LIFE')or die('v');
class vView{protected $cfg;public function __construct($t=''){if(!$t)$t=strtolower(substr(get_class($this),0,-4));$k=$t.'_cfg';global $$k;if(!$$k){include PATH_WORKING.DS.$k.'.php';vRegistry::cfg($$k,$t);}$this->cfg=& $$k;}public function render($d=null,$c=0){global $tpl,$cfg,$alt,$map;$m=& $this->cfg['structure'];$t=vPage::alt('task');if($this->cfg['tpl']){if($this->cfg['tpl']!==true)$this->cfg['tpl']=$tpl->theme('body',$this->cfg['tpl']);}else{$a=&$this->cfg['task'][$t];if(isset($a['tpl'])&&$a['tpl'])$this->cfg['tpl']=$tpl->theme('body',$a['tpl']);}if($this->cfg['tpl']!==true&&method_exists($this,$t.'_tpl')){$tpl->theme('body','',$this->{$t.'_tpl'}($d,$c));}switch(($this->cfg['task'][$t]['type'])?$this->cfg['task'][$t]['type']:0){case 1:$tpl->block($t,$d[0],true);if(isset($cfg['og'])&&$cfg['og']){vPage::head('<meta property="og:type" content="article" />');if(isset($d[0]['title']))vPage::head('<meta property="og:title" content="'.$d[0]['title'].'" />');if(isset($d[0]['preview']))vPage::head('<meta property="og:description" content="'.strip_tags($d[0]['preview']).'" />');$pic=isset($d[0]['o_pic_thumb'])?$d[0]['o_pic_thumb']:'';if(isset($d[0]['o_pic_full'])&&$d[0]['o_pic_full']){$pic=URL_UPLOAD.$d[0]['o_pic_full'][0];}if($pic){$pic=vRequest::site(0).$pic;vPage::head('<meta property="og:image" content="'.$pic.'" />');}}$cfg['~seo']=1;if(isset($m['meta'])){if(!is_array($d[0]['meta']))$d[0]['meta']=vRegistry::parse($d[0]['meta']);if(isset($d[0]['meta']['d'])&&$d[0]['meta']['d'])vPage::head($d[0]['meta']['d'],'description');if(isset($d[0]['meta']['k'])&&$d[0]['meta']['k'])vPage::head($d[0]['meta']['k'],'keywords');if(isset($d[0]['meta']['t'])&&$d[0]['meta']['t'])vPage::head($d[0]['meta']['t'],'title');else if(isset($m['title']))vPage::head($d[0]['title'],'title');}else if(isset($this->cfg['prop']['typ'])&&$this->cfg['prop']['typ']==1)$cfg['~seo']=0;else vPage::head($d[0]['title'],'title');if(isset($d[1])&&$d[1])foreach($d[1] as $k=>$v)$tpl->block($t.'.next',$v,true);if(isset($d[2])&&$d[2])foreach($d[2] as $k=>$v)$tpl->block($t.'.prev',$v,true);break;case 2:$tpl->block($t,array('TITLE'=>$map->r[$alt['page']]['title'],'PAGING'=>vPaging::_($this->cfg['url'],$c,$this->cfg['prop']['pag'],$alt['paging'])));if($d){foreach($d as $k=>$v){$tpl->block($t.'.row',$v,true);}}break;case 3:if($d){foreach($d as $v){$tpl->block($t,$v,true);if(isset($v['r'])&&$v['r']){if(isset($this->cfg['prop']['hot'])&&$this->cfg['prop']['hot']){for($j=0;$j<$this->cfg['prop']['hot'];$j++){if($r=array_shift($v['r']))$tpl->block($t.'.hot',$r,true);}}foreach($v['r'] as $r){$tpl->block($t.'.row',$r,true);}}}}break;}}}