<?php
/**
* @version		$Id: sef.php 3 2014-12-24 8:26 phu $
* @package		vFramework.core.sef
* @copyright	(C) 2014 Vipcom. All rights reserved.
* @license		Commercial
*/
defined('V_LIFE')or die('v');
class vSEF{static function parse(){global $map,$cfg;if($v=vRequest::string('vsef')){if($v{0}=='/')$v=substr($v,1);if(substr($v,-1)=='/')$v=substr($v,0,-1);if($v){$a=explode("/",$v);$i=sizeof($a)- 1;if(substr($a[$i],-5)=='.html'){vRequest::set(VAR_ID,substr($a[$i],0,-5));array_pop($a);}$k='';if($cfg['langs']>1){if(isset($cfg['mls'])&&$k=self::mls()){vRequest::set(VAR_LANG,$k);}else if($a&&isset($cfg['language'][$a[0]])){vRequest::set(VAR_LANG,$a[0]);$k=$a[0];array_shift($a);}}$map=new vSitemap(true,$k);$p=0;$m='/';$s='';while($a){$k=$a[0];if($k=='null'||(isset($map->r[$k])&&($map->r[$k]['pid']==$p||$map->i[$map->r[$k]['pid']]['alias']=='/'))){$p=$map->r[$k]['id'];$m=array_shift($a);}else{$s=implode('/',$a);break;}}if($m)vRequest::set(VAR_PAGE,$m);if($s)vRequest::set(VAR_SECTION,$s);}}else{$k='';if(isset($cfg['mls'])&&$k=self::mls()){vRequest::set(VAR_LANG,$k);}$map=new vSitemap(true,$k);$v=substr(vFilter::text(urldecode($_SERVER['REQUEST_URI'])),strlen(URL_BASE));if($v&&!strpos($v,'null')){$s=URL_BASE;$p=strpos($v,'?');if($p){$v=substr($v,$p+1);if($v){if($v{0}=='?')$v=substr($v,1);parse_str($v,$v2);if(isset($v2['id'])){$i=$v2['id'];unset($v2['id']);if(isset($v2['l'])){$map=new vSitemap(true,$v2['l']);}if(isset($map->r[$v2['m']]['ctype'])){global $db;$db->query('SELECT alias FROM #__'.$map->r[$v2['m']]['ctype'].' WHERE id='.$i);if($db->affected_rows()){$v2['id']=$db->fetch_field('alias');}}}$v=http_build_query($v2);$s.=vSEF::_(array(1=>'',2=>$v));}}vPage::redirect($s);die;}}$v=vRequest::uri();$p=strpos($v,'?');if($p){$v=substr($v,$p+1);parse_str($v,$v2);foreach($v2 as $key=>$val){if($val)vRequest::set($key,$val);}}}static function mls(){global $cfg;$l='';$s=$_SERVER['HTTP_HOST'];if($s{2}=='.')$s=substr($s,0,2);if(isset($cfg['language'][$s])){$l=$s;}return $l;}static function render($s){return preg_replace_callback('#(href|action)=\"'.URL_BASE.VAR_INDEX.'([^\"]+)#i',array('vSEF','_'),$s);}static function _($m){global $map,$cfg,$alt;$p=$m[2];$e=$m[1];$p=str_replace('&amp;','&',urldecode(trim($p)));if($p{0}=='?')$p=substr($p,1);$h='';if(strpos($p,'#')!==false)list($p,$h)=explode('#',$p);parse_str($p,$p);$d='';if(isset($cfg['mls'])){$l='';$t=(isset($p[VAR_LANG])&&$p[VAR_LANG])?$p[VAR_LANG]:$cfg['lang'];if($alt['lang']!=$t){$d='http://'.(($t==$cfg['lang'])?'':$t.'.').$cfg['mls'];}}else{$l=($cfg['langs']>1&&isset($p[VAR_LANG])&&$p[VAR_LANG]!=$cfg['lang'])?$p[VAR_LANG].'/':'';}$t=0;if(!isset($p[VAR_LANG])&&$alt['lang']!=$cfg['lang']){$map->lang($cfg['lang']);$t=$cfg['lang'];}else if(isset($p[VAR_LANG])&&$p[VAR_LANG]){$map->lang($p[VAR_LANG]);$t=$p[VAR_LANG];}unset($p[VAR_LANG]);$m='';if(isset($p[VAR_PAGE])){if($p[VAR_PAGE]&&$p[VAR_PAGE]<>'/'){$m=$p[VAR_PAGE];$i=($t&&isset($map->lr[$t]))?$map->lr[$t][$m]:(isset($map->r[$m])?$map->r[$m]['id']:0);if($i&&isset($map->i[$i])&&$map->i[$i]['tree']['p']){$k=explode(',',$map->i[$i]['tree']['p']);$j=count($k)- 1;for($i=$j;$i>=0;$i--){if($map->i[$k[$i]]['alias']!='/')$m=(($t)?$map->l[$t][$k[$i]]:$map->i[$k[$i]]['alias']).'/'.$m;}}$m.='/';}unset($p[VAR_PAGE]);}$s='';if(isset($p[VAR_SECTION])){$s=($p[VAR_SECTION])?$p[VAR_SECTION].'/':'';unset($p[VAR_SECTION]);}$i=isset($p[VAR_ID])?$p[VAR_ID].'.html':'';unset($p[VAR_ID]);$v=($p)?'?'.http_build_query($p):'';return(($e)?$e.'="'.$d.URL_BASE:'').$l.$m.$s.$i.$v.(($h)?'#'.$h:'');}}