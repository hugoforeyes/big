<?php
/**
* @version		$Id: spreadsheet.php 3 2012-08-14 18:01 sy $
* @package		vFramework.core.excel
* @copyright	(C) 2012 Vipcom. All rights reserved.
* @license		Commercial
*/
defined('V_LIFE')or die('v');define('PHPEXCEL_ROOT',PATH_CORE.DS.'excel'.DS);
class vSpreadsheet{private static $_d;private $format='';public $note=array();private $loaded=array();public $timestamp=array();public static function instance($format='xls'){if(is_null(self::$_d)){self::$_d=new self($format);}return self::$_d;}public function __construct($format='xls'){ini_set('default_charset','UTF-8');$this->format=$format;include PATH_CORE.DS.'excel/phpexcel.php';include PATH_CORE.DS.'excel/reader/defaultreadfilter.php';include PATH_CORE.DS.'excel/shared/zipstreamwrapper.php';include PATH_CORE.DS.'excel/shared/font.php';include PATH_CORE.DS.'excel/shared/string.php';include PATH_CORE.DS.'excel/shared/ole.php';include PATH_CORE.DS.'excel/shared/oleread.php';include PATH_CORE.DS.'excel/shared/codepage.php';include PATH_CORE.DS.'excel/shared/ole/pps.php';include PATH_CORE.DS.'excel/shared/ole/pps/file.php';include PATH_CORE.DS.'excel/shared/ole/pps/root.php';include PATH_CORE.DS.'excel/worksheet.php';include PATH_CORE.DS.'excel/cachedobjectstorage/cachebase.php';include PATH_CORE.DS.'excel/cachedobjectstoragefactory.php';include PATH_CORE.DS.'excel/cachedobjectstorage/memory.php';include PATH_CORE.DS.'excel/worksheet/pagesetup.php';include PATH_CORE.DS.'excel/worksheet/pagemargins.php';include PATH_CORE.DS.'excel/worksheet/headerfooter.php';include PATH_CORE.DS.'excel/worksheet/sheetview.php';include PATH_CORE.DS.'excel/worksheet/protection.php';include PATH_CORE.DS.'excel/worksheet/rowdimension.php';include PATH_CORE.DS.'excel/worksheet/columndimension.php';include PATH_CORE.DS.'excel/documentproperties.php';include PATH_CORE.DS.'excel/documentsecurity.php';include PATH_CORE.DS.'excel/style.php';include PATH_CORE.DS.'excel/style/font.php';include PATH_CORE.DS.'excel/style/color.php';include PATH_CORE.DS.'excel/style/fill.php';include PATH_CORE.DS.'excel/style/borders.php';include PATH_CORE.DS.'excel/style/border.php';include PATH_CORE.DS.'excel/style/alignment.php';include PATH_CORE.DS.'excel/style/numberformat.php';include PATH_CORE.DS.'excel/style/protection.php';include PATH_CORE.DS.'excel/calculation.php';include PATH_CORE.DS.'excel/cell.php';include PATH_CORE.DS.'excel/cell/datatype.php';include PATH_CORE.DS.'excel/cell/defaultvaluebinder.php';include PATH_CORE.DS.'excel/cell/advancedvaluebinder.php';include PATH_CORE.DS.'excel/referencehelper.php';include PATH_CORE.DS.'excel/worksheetiterator.php';include PATH_CORE.DS.'excel/hashtable.php';include PATH_CORE.DS.'excel/calculation/logical.php';include PATH_CORE.DS.'excel/calculation/mathtrig.php';include PATH_CORE.DS.'excel/calculation/function.php';include PATH_CORE.DS.'excel/calculation/functions.php';include PATH_CORE.DS.'excel/settings.php';include PATH_CORE.DS.'excel/shared/xmlwriter.php';include PATH_CORE.DS.'excel/shared/date.php';include PATH_CORE.DS.'excel/shared/file.php';}public function import($file){$data=array();$max_empty_top=5;$max_empty_bottom=5;if($this->format=='xls'){if(!isset($this->loaded['r5'])){$this->loaded['r5']=1;include PATH_CORE.DS.'excel/reader/excel5.php';}$phpexcel=new PHPExcel_Reader_Excel5();}else if($this->format=='xlsx'){if(!isset($this->loaded['r7'])){$this->loaded['r7']=1;include PATH_CORE.DS.'excel/reader/excel2007.php';}$phpexcel=new PHPExcel_Reader_Excel2007();}$excel=$phpexcel->load($file);$sheet=$excel->setActiveSheetIndex(0);$highestRow=$sheet->getHighestRow();$highestColumn=$sheet->getHighestColumn();$last=1;$readed=0;$colums='';$data=array();for($r=1;$r<=$highestRow;$r++){$row=$sheet->rangeToArray('A'.$r.':'.$highestColumn.$r,null,true,true,true);$row=$row[$r];if(!$row['A']){if(!$readed){if($r<$max_empty_top){$this->note[]=($row['B'])?$row['B']:'';continue;}else{$r=$highestRow + 1;}}}$empty=1;$col=0;foreach($row as $k=>&$v){if($v===null)$v='';if($v){if($readed==1){$number_format=$sheet->getStyle($k.$r)->getNumberFormat();if(PHPExcel_Shared_Date::isDateTimeFormat($number_format)){$value=$sheet->getCellByColumnAndRow($col,$r)->getCalculatedValue();$v=PHPExcel_Shared_Date::ExcelToPHP($value);}}$empty=0;}$col++;}if($empty==1){if($r<$last + $max_empty_bottom){continue;}else{$r=$highestRow + 1;}}if($r<=$highestRow){if(!$readed){$colums=$row;$readed=1;}else{$data[]=array_combine($colums,$row);$last=$r;}}}return $data;}public function export($data,$filename,$path=''){if(count($data)>0){if($this->format=='xls'){if(!isset($this->loaded['w5'])){$this->loaded['w5']=1;include PATH_CORE.DS.'excel/writer/excel5/parser.php';include PATH_CORE.DS.'excel/writer/excel5/font.php';include PATH_CORE.DS.'excel/writer/excel5/biffwriter.php';include PATH_CORE.DS.'excel/writer/excel5/workbook.php';include PATH_CORE.DS.'excel/writer/excel5/worksheet.php';include PATH_CORE.DS.'excel/writer/excel5/xf.php';include PATH_CORE.DS.'excel/writer/excel5.php';}}else if($this->format=='xlsx'){if(!isset($this->loaded['w7'])){$this->loaded['w7']=1;include PATH_CORE.DS.'excel/writer/excel2007/writerpart.php';include PATH_CORE.DS.'excel/writer/excel2007/stringtable.php';include PATH_CORE.DS.'excel/writer/excel2007/contenttypes.php';include PATH_CORE.DS.'excel/writer/excel2007/docprops.php';include PATH_CORE.DS.'excel/writer/excel2007/rels.php';include PATH_CORE.DS.'excel/writer/excel2007/style.php';include PATH_CORE.DS.'excel/writer/excel2007/workbook.php';include PATH_CORE.DS.'excel/writer/excel2007/worksheet.php';include PATH_CORE.DS.'excel/writer/excel2007.php';}}$excel=new PHPExcel();$excel->setActiveSheetIndex(0);$sheet=$excel->getActiveSheet();$r=1;$c=0;foreach($this->note as $v){$sheet->setCellValueByColumnAndRow(1,$r++,$v);}foreach($data[0] as $k=>$v){$sheet->setCellValueByColumnAndRow($c++,$r,$k);}$r++;foreach($data as $row){$c=0;foreach($row as $k=>$v){if(isset($this->timestamp[$k])){$v=PHPExcel_Shared_Date::PHPToExcel($v);$sheet->getStyle($sheet->getCellByColumnAndRow($c,$r)->getColumn().$r)->getNumberFormat()->setFormatCode('dd/mm/yyyy');}$sheet->setCellValueByColumnAndRow($c++,$r,$v);}$r++;}ob_end_clean();PHPExcel_Cell::setValueBinder(new PHPExcel_Cell_AdvancedValueBinder());if($this->format=='xls'){$objWriter=new PHPExcel_Writer_Excel5($excel);if(!$path){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment;filename="'.$filename.'"');header('Cache-Control: max-age=0');$objWriter->save('php://output');}else{$objWriter->save($path.$filename);}}else if($this->format=='xlsx'){$objWriter=new PHPExcel_Writer_Excel2007($excel);if(!$path){header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header('Content-Disposition: attachment;filename="'.$filename.'"');header('Cache-Control: max-age=0');$objWriter->save('php://output');}else{$objWriter->save($path.$filename);}}unset($excel);return true;}return false;}public function import_data($d,$l,$m,$f,$g,$s,$c,$cid=0){$lan=vPage::cfg('language');unset($lan[vPage::cfg('lang')]);if($l>1){foreach($d as $k=>$v)$r[$k]=array();}else $r='';for($i=0,$n=count($d);$i<$n;$i++){$v=& $d[$i];foreach($g as $k){$a=array();if($m[$k]=='meta'){foreach(array('t','k','d')as $j){$a[$j]=isset($v[$k.'_'.$j])?$v[$k.'_'.$j]:'';unset($v[$k.'_'.$j]);}$v[$k]=vRegistry::ini($a);if($r&&isset($s[$k])){foreach($lan as $z=>$w){$a=array();foreach(array('t','k','d')as $j){$a[$j]=isset($v[$k.'_'.$j.'__'.$z])?$v[$k.'_'.$j.'__'.$z]:'';unset($v[$k.'_'.$j.'__'.$z]);}$r[$i][$z][$k]=vRegistry::ini($a);}}}else if($m[$k]=='prop'){if($k=='prop'&&$c){foreach($c as $j=>$y){$a[$j]=isset($v[$k.'_'.$j])?$v[$k.'_'.$j]:'';unset($v[$k.'_'.$j]);}$v[$k]=vRegistry::ini($a);if($r&&isset($s[$k])){foreach($lan as $z=>$w){$a=array();foreach($c as $j=>$y){$a[$j]=isset($v[$k.'_'.$j.'__'.$z])?$v[$k.'_'.$j.'__'.$z]:'';unset($v[$k.'_'.$j.'__'.$z]);}$r[$i][$z][$k]=vRegistry::ini($a);}}}else{}}}if($r){foreach($lan as $z=>$w){foreach($s as $k=>$y){if(isset($v[$k.'__'.$z])){$r[$i][$z][$k]=$v[$k.'__'.$z];unset($v[$k.'__'.$z]);}}}}}$n=count($d);$a=array_diff(array_keys($d[0]),$f);foreach($a as $k){for($i=0,$n;$i<$n;$i++){$v=& $d[$i];unset($v[$k]);if($cid)$v['cid']=$cid;}}if($r){$d['_']=$r;}return $d;}public function export_data($d,$l,$m,$f,$g,$s,$c){$lan=vPage::cfg('language');unset($lan[vPage::cfg('lang')]);$r=isset($d['_'])?$d['_']:'';unset($d['_']);for($i=0,$n=count($d);$i<$n;$i++){$v=& $d[$i];foreach($g as $k){if($m[$k]=='meta'){$v[$k]=vRegistry::parse($v[$k]);foreach(array('t','k','d')as $j){$v[$k.'_'.$j]=isset($v[$k][$j])?$v[$k][$j]:'';}unset($v[$k]);if($r&&isset($s[$k])){foreach($lan as $z=>$w){if(isset($r[$z][$i][$k])){$r[$z][$i][$k]=vRegistry::parse($r[$z][$i][$k]);foreach(array('t','k','d')as $j){$r[$z][$i][$k.'_'.$j]=isset($r[$z][$i][$k][$j])?$r[$z][$i][$k][$j]:'';$s[$k.'_'.$j]=1;}unset($r[$z][$i][$k]);}}}}else if($m[$k]=='prop'){if($k=='prop'&&$c){$v[$k]=vRegistry::parse($v[$k]);foreach($c as $j=>$y){$v[$k.'_'.$j]=isset($v[$k][$j])?$v[$k][$j]:'';}unset($v[$k]);if($r&&isset($s[$k])){foreach($lan as $z=>$w){if(isset($r[$z][$i][$k])){$r[$z][$i][$k]=vRegistry::parse($r[$z][$i][$k]);foreach($c as $j=>$y){$r[$z][$i][$k.'_'.$j]=isset($r[$z][$i][$k][$j])?$r[$z][$i][$k][$j]:'';$s[$k.'_'.$j]=1;}unset($r[$z][$i][$k]);}}}}else{}}}if($r){$a=array();foreach($v as $k=>$w){$a[$k]=$w;if(isset($s[$k])){foreach($lan as $j=>$y){$a[$k.'__'.$j]=isset($r[$j][$i][$k])?$r[$j][$i][$k]:'';}}}$v=$a;}}return $d;}}