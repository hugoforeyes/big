<?php
/**
 * @version		$Id: captcha.php 3 2015-08-02 9:43 Phu $
 * @package		vFramework.core.captcha
 * @copyright	(C) 2015 Vipcom. All rights reserved.
 * @license		Commercial
 */
defined('V_LIFE')or die('v');require(defined('V_CP')?PATH_CP_CTYPE.DS.'staff':PATH_CTYPE.DS.'blk_captcha').DS.'captcha.php';
class vCaptcha{var $d=array();var $r=array();var $i=array();var $c=0;static function sid($s=''){$s=md5($s?$s:microtime());$d=array($s=>'');mt_srand(microtime()* 1000000);$l=strlen(CAPTCHA_CHARS)- 1;$a=CAPTCHA_CHARS;for($i=0;$i<CAPTCHA_COUNT;$i++)$d[$s].=$a{mt_rand(0,$l)};$d['i']=vRequest::ip();if(defined('V_CP')){global $stf;if(!isset($stf))$stf=vSession::instance();$e=& $stf;}else{global $mem;if(!isset($mem))$mem=vSession::instance();$e=& $mem;}$e->session('set','captcha',$d);return $s;}static function check($s,$c){$f=0;if(defined('V_CP')){global $stf;if(!isset($stf))$stf=vSession::instance();$e=& $stf;}else{global $mem;if(!isset($mem))$mem=vSession::instance();$e=& $mem;}$d=$e->session('get','captcha');if($s&&$c&&isset($d[$s])){if(CAPTCHA_CAPS)$c=strtoupper($c);$f=($d[$s]==$c)?$c:0;$e->session('clear','captcha');}return $f;}static function hex2rgb($s){$s=preg_replace("/[^0-9A-Fa-f]/",'',$s);$r=array();if(strlen($s)==6){$t=hexdec($s);$r['r']=0xFF &($t>>0x10);$r['g']=0xFF &($t>>0x8);$r['b']=0xFF & $t;}elseif(strlen($s)==3){$r['r']=hexdec(str_repeat(substr($s,0,1),2));$r['g']=hexdec(str_repeat(substr($s,1,1),2));$r['b']=hexdec(str_repeat(substr($s,2,1),2));}else return false;return $r;}static function draw($s=''){if(defined('V_CP')){global $stf;if(!isset($stf))$stf=vSession::instance();$e=& $stf;}else{global $mem;if(!isset($mem))$mem=vSession::instance();$e=& $mem;}$d=$e->session('get','captcha');if(isset($d[$s]))$s=strip_tags($d[$s]);if(!$s)return;mt_srand(microtime()* 100);$w=CAPTCHA_WIDTH;$h=CAPTCHA_HEIGHT;$img=imagecreatetruecolor($w,$h);if(CAPTCHA_BG_COLOR){$bgcolor=vCaptcha::hex2rgb(CAPTCHA_BG_COLOR);$bgcolor=imagecolorallocate($img,$bgcolor['r'],$bgcolor['g'],$bgcolor['b']);}else $bgcolor=imagecolorallocate($img,mt_rand(200,255),mt_rand(200,255),mt_rand(200,255));imagefill($img,0,0,$bgcolor);if(CAPTCHA_COLOR){$color=vCaptcha::hex2rgb(CAPTCHA_COLOR);$color=imagecolorallocate($img,$color['r'],$color['g'],$color['b']);}else $color=imagecolorallocate($img,mt_rand(0,200),mt_rand(0,200),mt_rand(0,200));$linecolor=CAPTCHA_LINE_COLOR?$color:$bgcolor;imagesetthickness($img,1);$a=rand(0,$w-(CAPTCHA_FONT_UNIT*CAPTCHA_COUNT));for($i=0;$i<CAPTCHA_COUNT;$i++){imagettftext($img,mt_rand(CAPTCHA_FONT_MIN,CAPTCHA_FONT_MAX),mt_rand(-CAPTCHA_FONT_ANGLE,CAPTCHA_FONT_ANGLE),$a,mt_rand(CAPTCHA_FONT_MIN,CAPTCHA_HEIGHT),$color,(defined('V_CP')?PATH_CP_CTYPE.DS.'staff':PATH_CTYPE.DS.'blk_captcha').DS.CAPTCHA_FONT,$s{$i});$a+=mt_rand(CAPTCHA_FONT_UNIT*0.9,CAPTCHA_FONT_UNIT*1.1);}if(CAPTCHA_LINE_VER){$a=$w / CAPTCHA_LINE_VER;for($i=0;$i<CAPTCHA_LINE_VER;$i++)imageline($img,mt_rand(-$a,$a)+($i*$a),1,mt_rand(-$a,$a)+($i*$a),$h,$linecolor);}if(CAPTCHA_LINE_HOR){$a=$w / CAPTCHA_LINE_HOR;for($i=0;$i<CAPTCHA_LINE_HOR;$i++)imageline($img,1,mt_rand(-$a,$a)+($i*$a),$w,mt_rand(-$a,$a)+($i*$a),$linecolor);}header("Content-type: image/jpeg");imagepng($img);imagedestroy($img);}}