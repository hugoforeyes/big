<?php
/**
* @version		$Id: module.php 2 2011-12-08 13:39 phu $
* @package		vFramework.cp.module
* @copyright	(C) 2011 Vipcom. All rights reserved.
* @license		Commercial
*/
defined('V_LIFE')or die('v');
class vCPModule{protected $table='';protected $model='id:int,cid:page,lang,title,alias,preview:text,content:html,pic_thumb:image,hits:int,hot:int,prop:prop,meta:meta,created:int,modified:int,published:int';protected $trans='';protected $langs=0;protected $url;protected $cfg;protected $msg=array(0);protected $ret=0;protected $ext=null;protected $task=array('listing'=>array('auth'=>'access','cmd'=>'create,delete,publish,hot,move','filter'=>'search,publish,order','model'=>'title,pic_thumb,hot,hits,published',),'edit'=>array('auth'=>'edit','model'=>'title,alias,pic_thumb,preview,content','null'=>'title',),'view'=>array('auth'=>'access',),'delete'=>array('auth'=>'delete',),'publish'=>array('auth'=>'publish',),'hot'=>array('auth'=>'publish',),);public function __construct(){global $alt,$map,$tpl;if($this->table=='')$this->table=strtolower(get_class($this));$m=&$this->model;if(is_string($m)){$t=preg_split('/[\n,;]/',$m);$m=array();foreach($t as $v){$v=preg_split('/[:=]/',$v.':');$m[$v[0]]=$v[1];}unset($t);}if($this->trans&&is_string($this->trans))$this->trans=preg_split('/[\n,;]/',$this->trans);foreach($this->task as $k=>$v){$m=&$this->task[$k];if(!isset($m['auth']))$m['auth']='';if(!isset($m['tpl']))$m['tpl']='';if(isset($m['cmd'])){if(is_string($m['cmd']))$m['cmd']=preg_split('/[\n,;]/',$m['cmd']);}else $m['cmd']='';if(isset($m['filter'])){if(is_string($m['filter']))$m['filter']=preg_split('/[\n,;]/',$m['filter']);}else $m['filter']='';if(isset($m['model'])){if(is_string($m['model']))$m['model']=preg_split('/[\n,;]/',$m['model']);}else $m['model']='';}if($alt['return']&&$alt['page']!='cp.staff'){$t=(isset($map->r[$alt['return']]))?$map->r[$alt['return']]['title']:$tpl->_($alt['return']);cpPage::nav($t,VAR_INDEX.'?'.VAR_LANG.'='.$alt['lang'].'&amp;'.VAR_PAGE.'='.$alt['return']);}if(isset($map->r[$alt['page']])){$alt['module']=&$map->r[$alt['page']];$this->cfg=&$map->r[$alt['page']]['prop'];$t=$alt['module']['title'];vPage::head($t,'title');}else{$alt['module']=null;$t=substr($alt['page'],3);vPage::head($tpl->_($t),'title');}$this->url=VAR_INDEX.'?'.VAR_LANG.'='.$alt['lang'].'&amp;'.VAR_PAGE.'='.$alt['page'].(($alt['return'])?'&amp;'.VAR_RETURN.'='.$alt['return']:'');cpPage::nav($t,$this->url);if($alt['section']){$this->url.='&amp;'.VAR_SECTION.'='.$alt['section'];if(!is_numeric($alt['section']))cpPage::nav($alt['section'],$this->url);}$this->url.='&amp;'.VAR_PUBLISH.'='.$alt['publish'].'&amp;'.VAR_KEYWORD.'='.urlencode($alt['keyword']).'&amp;'.VAR_PAGING.'='.$alt['paging'];foreach($alt['filter'] as $k=>$v)$this->url.='&amp;filter['.$k.']='.$v;}function __destruct(){global $alt;}public function exec($t=''){global $alt,$stf,$cfg;do{if($this->ret)$t=isset($this->task[$t]['redirect'])?$this->task[$t]['redirect']:'';else if(!$t)$t=$alt['task'];if($t=='create')$t='edit';reset($this->task);$t=isset($this->task[$t])?$t:key($this->task);if(($this->task[$t]['auth']&&!$stf->{$this->task[$t]['auth']})||(isset($stf->{$t})&&!$stf->{$t}))cpPage::null();$alt['task']=$t;$this->ret=0;$this->{$t}();}while($this->ret);$s=$this->msg;$t=array_shift($s);if($s){$s=implode('<br />',$s);if($t==1)cpPage::warning($s);else if($t==2)cpPage::error($s);else cpPage::report($s);}}protected function listing(){global $alt,$db,$cfg;$s=$this->listing_sql();if(!$db->query($s[0],$cfg['paging'],($alt['paging']-1)*$cfg['paging']))trigger_error($db->error(),E_USER_ERROR);if($db->affected_rows()==0&&$alt['paging']>1){$alt['paging']=1;if(!$db->query($s[0],$cfg['paging']))trigger_error($db->error(),E_USER_ERROR);}$d=$db->fetch();if(!$db->query($s[1]))trigger_error($db->error(),E_USER_ERROR);$c=$db->fetch_field('total');$d=$this->listing_data($d);$this->listing_display($d,$c);$this->listing_cmd();$this->listing_filter();}protected function listing_data($d){global $tpl,$stf,$cfg,$alt;$m=&$this->model;for($i=0,$n=count($d);$i<$n;$i++){$v=&$d[$i];$v['CSS']='enabled';if(isset($v['enabled']))$v['CSS']=($v['enabled'])?'enabled':'disabled';else if(isset($v['published']))$v['CSS']=($v['published'])?'enabled':'disabled';if(isset($v['published']))$v['published']=vTime::format($cfg['date']['input'],$v['published']);$v['ICON']=((isset($m['pic_thumb'])&&isset($v['pic_thumb'])&&$v['pic_thumb'])?'<span class="ico ipic"></span>':'').((isset($m['hot'])&&isset($v['hot'])&&$v['hot'])?'<span class="ico ihot"></span>':'').(($this->langs&&isset($m['lang'])&&$cfg['langs']>1&&$alt['lang']=='')?(($this->table=='blocks'&&!$v['lang'])?'':'<span class="lang i'.((isset($v['lang'])&&$v['lang'])?$v['lang']:$cfg['lang']).'"></span>'):'');if(isset($m['ordering'])&&isset($v['ordering']))$v['ordering']='<input type="text" name="order['.$v['id'].']" value="'.$v['ordering'].'" style="width:35px;" />'.(($stf->move)?'<a href="'.$this->url.'&amp;'.VAR_TASK.'=order&amp;'.VAR_ACTION.'=up&amp;'.VAR_ID.'='.$v['id'].'" title="'.$tpl->l['UP'].'"><span class="ico iup"></span></a>':'').(($stf->move)?'<a href="'.$this->url.'&amp;'.VAR_TASK.'=order&amp;'.VAR_ACTION.'=down&amp;'.VAR_ID.'='.$v['id'].'" title="'.$tpl->l['DOWN'].'"><span class="ico idown"></span></a>':'');$v['U_VIEW']=isset($this->task['view'])?'javascript:view(\''.$this->url.'&'.VAR_TASK.'=view&'.VAR_ID.'='.$v['id'].'\');':'';$v['CMD']=(!$stf->edit||(!$stf->publish&&((isset($v['enabled'])&&$v['enabled'])||(isset($v['published'])&&$v['published']))))?'':'<a href="'.$this->url.'&amp;t=edit&amp;id='.$v['id'].'" title="'.$tpl->l['EDIT'].'"><span class="ico iedit"></span></a>';}return $d;}protected function listing_display($d,$c=0){global $tpl,$cfg,$alt,$stf;$m=&$this->model;$t=$this->task[$alt['task']]['model'];$t=array_diff($t,array('pic_thumb','hot','lang'));$h='<form id="main_form" name="main_form" method="POST" action="'.$this->url.'">
<table class="list"><thead><tr><td class="cw1"><input type="checkbox" name="checkall" class="checkbox checkall" /></td>';foreach($t as $i){if(isset($m[$i]))$h.='	<td class="th_'.$i.(($m[$i]=='int')?' cw2':'').'">'.$tpl->_($i).(($i=='ordering'&&$stf->move)?' <a href="javascript:cmd(\'order\')"><span class="ico isave"></span></a>':'').'</td>';}$h.='</tr></thead><tbody>';$a=isset($m['title'])?'title':$t[0];foreach($d as $k=>$v){$h.='<tr class="tbrow"><td class="'.$v['CSS'].' center"><input type="checkbox" name="ids['.$v['id'].']" value="'.$v['id'].'" class="checkbox" /></td>';foreach($t as $i){if(isset($m[$i])){if($i==$a)$h.=' <td class="'.$v['CSS'].' title"><a'.(($v['U_VIEW'])?' href="'.$v['U_VIEW'].'"':'').' class="'.$v['CSS'].'">'.$v['ICON'].$v[$i].'</a><div class="actions">'.$v['CMD'].'</div></td>';else $h.=' <td class="'.$v['CSS'].(($m[$i]=='int')?' center':'').'">'.$v[$i].'</td>';}}$h.='</tr>';}$h.='</tbody></table></form>';$tpl->theme('body','',"@$h");cpPage::count($c);$tpl->vars(array('PAGINATION'=>vPage::paging($this->url,$c,$cfg['paging'],$alt['paging']),'S_LIST'=>$this->url,'S_FILTER'=>$this->url,));}protected function listing_sql(){global $alt,$cfg,$map;$m=&$this->model;$t=$this->task[$alt['task']]['model'];if(isset($m['ordering'])&&isset($m['tree']))$cfg['paging']=999;$l=($cfg['langs']>1&&$this->langs)?(($this->trans)?2:1):0;$lc=($alt['lang']&&$alt['lang']<>$cfg['lang'])?1:0;if(isset($m['id'])&&!in_array('id',$t))array_unshift($t,'id');if($l==1&&isset($m['lang'])&&!in_array('lang',$t))array_push($t,'lang');if(isset($m['enabled'])&&!in_array('enabled',$t))array_push($t,'enabled');if(isset($m['published'])&&!in_array('published',$t))array_push($t,'published');$s='SELECT '.substr(str_replace(',',',a.',','.implode(',',$t)),1);$w=(isset($m['cid']))?' WHERE a.cid="'.$map->r[$alt['page']]['id'].'"':' WHERE 1';$a='';if(isset($m['published']))$a='published';else if(isset($m['enabled']))$a='enabled';$w.=($alt['publish']&&$a)?(($alt['publish']==1)?' AND a.'.$a.'>0':' AND a.'.$a.'=0'):'';if(isset($m['title']))$w.=($alt['keyword'])?' AND '.(($l==2&&$lc)?'t':'a').'.title LIKE "%'.$alt['keyword'].'%"':'';if(isset($m['hot']))$w.=($alt['hot'])?' AND a.hot=1':'';if($l==1&&$alt['lang'])$w.=' AND ('.(($alt['lang']==$cfg['lang'])?'a.lang="" OR ':'').'a.lang="'.$alt['lang'].'")';foreach($this->task['listing']['filter'] as $a){if(!in_array($a,array('search','publish'))&&isset($m[$a]))$w.=(isset($alt['filter'][$a])&&$alt['filter'][$a])?' AND a.'.$a.'="'.$alt['filter'][$a].'"':'';}$f=' FROM #__'.$this->table.' a';if($l==2&&$lc){$f.=' LEFT JOIN #__'.$this->table.'_trans t ON a.id=t.id';$w.=' AND t.lang="'.$alt['lang'].'"';foreach($this->trans as $a)$s=str_replace('a.'.$a,'t.'.$a,$s);}$o='';if(isset($m['ordering'])){$o=' ORDER BY ordering ASC';}else if(isset($alt['filter']['ord'])&&$alt['filter']['ord']){$a=explode('_',$alt['filter']['ord']);if(isset($m[$a[0]]))$o=' ORDER BY '.$a[0].' '.$a[1];}return array(array('s'=>$s,'f'=>$f,'w'=>$w,'o'=>$o),array('s'=>'SELECT count(*) as total','f'=>$f,'w'=>$w));}protected function listing_cmd(){global $alt;$t=&$this->task[$alt['task']]['cmd'];foreach($t as $k=>$v){if($v=='move'&&!isset($this->task['move']))cpPage::cmd($v,'javascript:cmd(\''.VAR_INDEX.'?'.VAR_PAGE.'=cp.sitemap&'.VAR_TASK.'=move&from='.$alt['module']['id'].'\');');else cpPage::cmd($v);}}protected function listing_filter(){global $alt,$cfg;$t=&$this->task[$alt['task']]['filter'];foreach($t as $k=>$v)cpPage::filter($v);if($cfg['langs']>1&&$this->langs)cpPage::filter(($this->trans)?'language':'language_all');}protected function hot(){global $alt,$db;$ids=vRequest::_var('ids');if(is_array($ids))$ids=implode(',',$ids);if($ids){$s='UPDATE #__'.$this->table.' SET hot=abs(hot-1) WHERE id IN ('.$ids.')';if(!$db->query($s))trigger_error($db->error(),E_USER_ERROR);}else{$alt['hot']=1;}$this->ret=1;}protected function order(){global $db,$alt,$tpl;if($alt['id']){$s='SELECT '.(isset($this->model['pid'])?'pid,':'').'ordering FROM #__'.$this->table.' WHERE id='.$alt['id'];if(!$db->query($s,1))trigger_error($db->error(),E_USER_ERROR);if($d=$db->fetch_row()){$s='SELECT id, ordering FROM #__'.$this->table.'
				WHERE id<>'.$alt['id'].(isset($this->model['pid'])?' AND pid='.$d['pid']:'').'
					AND ordering'.(($alt['action']=='up')?'<':'>').$d['ordering'].'
				ORDER BY ordering '.(($alt['action']=='up')?'DESC':'ASC');if(!$db->query($s,1))trigger_error($db->error(),E_USER_ERROR);if($db->affected_rows()){$d2=$db->fetch_row();$s='UPDATE #__'.$this->table.'
					SET ordering='.$d2['ordering'].'
					WHERE id='.$alt['id'];if(!$db->query($s))trigger_error($db->error(),E_USER_ERROR);$s='UPDATE #__'.$this->table.'
					SET ordering='.$d['ordering'].'
					WHERE id='.$d2['id'];if(!$db->query($s))trigger_error($db->error(),E_USER_ERROR);}}}else{foreach(vRequest::_var('order')as $k=>$v){$s='UPDATE #__'.$this->table.' SET ordering='.intval($v).' WHERE id='.intval($k);if(!$db->query($s))trigger_error($db->error(),E_USER_ERROR);}}if(isset($this->task['resync']))$this->resync();$this->ret=1;}protected function publish(){global $db;$ids=vRequest::_var('ids');$m=&$this->model;if($ids){$ids=implode(',',$ids);if(isset($m['enabled'])){$sql='UPDATE #__'.$this->table.' SET enabled=abs(enabled-1) WHERE id IN ('.$ids.')';if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);}else if(isset($m['published'])){$sql='SELECT id, published FROM #__'.$this->table.' WHERE id IN ('.$ids.')';if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);$d=$db->fetch();$t=time();foreach($d as $v){$sql='UPDATE #__'.$this->table.' SET published='.(($v['published'])?0:$t).' WHERE id='.$v['id'];if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);$t++;}}}$this->ret=1;}protected function delete(){global $db,$map,$file,$cfg,$alt,$stf;$ids=vRequest::_var('ids');if($ids){$ids=implode(',',$ids);if(!isset($file))require_once(PATH_CORE.DS.'file.php');$m=&$this->model;$t='';foreach($m as $k=>$v){if(in_array($v,array('image','media','file','images','medias','files')))$t[]=$k;}if($t){$sql='SELECT '.implode(',',$t).' FROM #__'.$this->table.' WHERE id IN ('.$ids.')';if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);$d=$db->fetch();foreach($d as $k=>$v){foreach($v as $f){if($f){$f=explode("\n",$f);foreach($f as $i)if($i&&substr($i,0,7)!=='http://')@$file->delete($i);}}}}if($cfg['log']){$id=array();$t=array();$s='SELECT id'.(isset($m['title'])?',title':'').' FROM #__'.$this->table.' WHERE id IN ('.$ids.')';if(!$db->query($s))trigger_error($db->error(),E_USER_ERROR);foreach($db->fetch()as $v){$id[]=$v['id'];if(isset($m['title']))$t[]=$v['title'];}$stf->logs($alt['page'],'delete',array('ids'=>implode(',',$id),'title'=>implode(' | ',$t),));}$sql='DELETE FROM #__'.$this->table.' WHERE id IN ('.$ids.')';if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);if($cfg['langs']>1&&$this->langs&&$this->trans){$sql='DELETE FROM #__'.$this->table.'_trans WHERE id IN ('.$ids.')';if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);}if(isset($this->task['resync']))$this->resync();else $map->count();}$this->ret=1;}protected function view(){global $db,$alt;cpPage::nav('Quick_view');if($alt['id']){$s=$this->view_sql();if(!$db->query($s))trigger_error($db->error(),E_USER_ERROR);$d=$db->fetch_row();$d=$this->view_data($d);$this->view_display($d);}}protected function view_sql(){global $alt;$s='SELECT * FROM #__'.$this->table.' WHERE id='.$alt['id'];return $s;}protected function view_data($d){global $tpl;foreach($this->model as $k=>$v){if($v=='html')$d[$k]=$tpl->purl($d[$k]);}unset($d['cid']);unset($d['lang']);unset($d['hot']);return $d;}protected function view_display($d){global $tpl;$h='<div class="form_wra"><div class="tr_wra"><div class="td_wra"><table class="form">';foreach($d as $k=>$v)$h.='<tr><th>'.$tpl->_($k).'</th><td>'.$v.'</td></tr>';$h.='</table></div></div></div>';$tpl->theme('body','',"@$h");}protected function move(){$a=0;if(vRequest::issubmit('update'))$a=$this->move_submit();if($a){if(isset($this->task['resync']))$this->resync();$this->ret=1;}else{cpPage::nav('Move');cpPage::cmd('update');cpPage::cmd('cancel',$this->url);$this->move_form($this->move_data());}}protected function move_data(){global $tpl,$map,$ctype,$db;$i=vRequest::_var('ids');$f=vRequest::int('from');$s='';if(is_array($i)){if($f&&isset($map->i[$f])){$s=$map->i[$f]['ctype'];}else{$f='';$s=array_shift($i);array_unshift($i,$s);$s=isset($map->i[$s])?$map->i[$s]['ctype']:'';}}if($s&&$ctype->r[$s]['func']==0)$s='';if($s==''){vPage::redirect($this->url);return;}$t=$map->select();foreach($t as $k=>$v){if($map->i[$k]['ctype']!=$s)unset($t[$k]);}$d['posts']='';if($f){$sql='SELECT id, title FROM #__'.$s.' WHERE id IN ('.implode(',',$i).')';if($db->query($sql)){$i=$db->fetch();foreach($i as $k)$d['posts'].='<p><input type="checkbox" name="ids['.$k['id'].']" id="r'.$k['id'].'" value="'.$k['id'].'" checked="checked" /><label for="r'.$k['id'].'">'.$k['title'].'</label></p>';}}else{foreach($i as $k)$d['posts'].='<p><input type="checkbox" name="ids['.$k.']" id="r'.$k.'" value="'.$k.'" checked="checked" /><label for="r'.$k.'">'.$map->i[$k]['title'].'</label></p>';}$d['to']=vForm::select($t,'to');$d['S_UPDATE']=$this->url.'&amp;'.VAR_TASK.'=move&amp;from='.$f;return $d;}protected function move_form($d){global $tpl;$h='<form id="main_form" name="main_form" method="POST" action="'.$d['S_UPDATE'].'">
<input type="hidden" name="update" value="1" /><input type="submit" class="hidden" name="s'.time().'" value="" />
<div class="form_wra"><div class="tr_wra"><div class="td_wra"><table class="form"><tr><th>'.$tpl->_('Posts').'</th><td>'.$d['posts'].'</td></tr>
<tr><th>'.$tpl->_('Move to').'</th><td>'.$d['to'].'</td></tr>
</table></div></div></div></form>';$tpl->theme('body','',$h);}protected function move_submit(){global $map,$db;$i=vRequest::_var('ids');$f=vRequest::int('from');$t=vRequest::int('to');if(isset($map->i[$t])){$s='';if($f&&isset($map->i[$f])){$s=$map->i[$f]['ctype'];}else if(is_array($i)){$s=array_shift($i);array_unshift($i,$s);$s=isset($map->i[$s])?$map->i[$s]['ctype']:'';}if($f)$sql='UPDATE #__'.$s.' SET cid='.$t.' WHERE id IN ('.implode(',',$i).')';else $sql='UPDATE #__'.$s.' SET cid='.$t.' WHERE cid IN ('.implode(',',$i).')';if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);cpPage::report('RP_MOVE');return 1;}return 0;}protected function creates($f=true){}protected function edit($f=true){global $alt,$db,$cfg,$tpl;$a=0;$d=null;if($f&&vRequest::issubmit('update')){$d=$this->edit_request();$a=$this->edit_submit($d);}if($a){$this->msg[]=$tpl->l['RP_UPDATE'];if($alt['_']['pageto'])$this->edit(false);else{if(isset($this->task['resync']))$this->resync();$this->ret=1;}}else{cpPage::nav(($alt['id'])?'Edit':'Create');$this->edit_cmd();if($alt['id']&&!$d){$s=$this->edit_sql();if(!$db->query($s[0]))trigger_error($db->error(),E_USER_ERROR);$d=$db->fetch_row();if($cfg['langs']>1&&$this->langs&&$this->trans){if(!$db->query($s[1]))trigger_error($db->error(),E_USER_ERROR);$a=$db->fetch();foreach($a as $v){$k=$v['lang'];unset($v['lang']);$d['_'][$k]=$v;}unset($a);}}$d=$this->edit_data($d);$this->edit_form($d);}}protected function edit_cmd(){global $alt;$t=&$this->task[$alt['task']]['edit'];if(isset($t['cmd'])){foreach($t['cmd'] as $k=>$v)cpPage::cmd($v);}else{cpPage::cmd('update');cpPage::cmd('cancel',$this->url);}}protected function edit_sql(){global $alt,$cfg;$s[0]='SELECT * FROM #__'.$this->table.' WHERE id='.$alt['id'];if(($cfg['langs']>1&&$this->langs&&$this->trans))$s[1]='SELECT lang,'.implode(',',$this->trans).' FROM #__'.$this->table.'_trans WHERE id='.$alt['id'];return $s;}protected function edit_data($d){return $d;}protected function edit_form($d){global $tpl,$alt,$cfg,$ctype;cpPage::editor();$h='<form id="main_form" name="main_form" method="POST" action="'.$this->url.'&amp;'.VAR_TASK.'=edit&amp;'.VAR_ID.'='.$alt['id'].'" ENCTYPE="multipart/form-data">
<input type="hidden" name="update" value="1" />
<input type="submit" name="s'.time().'" value="" class="hidden" />
<div class="form_wra"><div class="tr_wra"><div class="td_wra"><table class="form">';$m=&$this->model;$t=$this->task[$alt['task']]['model'];$n=&$this->task[$alt['task']]['null'];if(isset($m['lang'])&&$cfg['langs']>1&&$this->langs&&!$this->trans)$h.='<tr><th>'.$tpl->l['LANGUAGE'].'</th><td>'.cpPage::form('lang','',$d['lang'],'',($this->table=='blocks')?true:false).'</td></tr>';$p=array();foreach($t as $k){if($k&&isset($m[$k])&&!in_array($k,array('published','enabled')))$p[$k]=$m[$k];}if(isset($this->cfg['ext'])&&$this->cfg['ext']&&isset($m['prop'])&&!isset($p['prop']))$p['prop']='prop';if(isset($m['meta'])&&isset($this->cfg['seo'])&&$this->cfg['seo'])$p['meta']='meta';$h.=vForm::draw($p,$d,($cfg['langs']>1&&$this->langs&&$this->trans)?$this->trans:'',$n,isset($d['ctype'])?$d['ctype']:'');$h.='<tr><th></th><td>';if(isset($m['enabled']))$h.='<p><input type="checkbox" name="enabled" id="enabled" value="1"'.(($d['enabled']||(isset($alt['_']['enabled'])&&$alt['_']['enabled']))?' checked="checked"':'').' /><label for="enabled">'.$tpl->l['PUBLISH'].'</label></p>';else if(isset($m['published']))$h.='<p><input type="checkbox" name="enabled" id="enabled" value="1"'.(($d['published']||(isset($alt['_']['enabled'])&&$alt['_']['enabled']))?' checked="checked"':'').' /><label for="enabled">'.$tpl->l['PUBLISH'].'</label> <input type="text" name="published" id="published" class="calendar" maxlength="25" value="'.vTime::format($cfg['date']['input'],$d['published']).'"> <span class="note">'.$tpl->_('Published format').'</span></p>';if(isset($d['id'])&&$d['id'])$h.='<p><input type="checkbox" name="saveas" id="saveas" value="1" /><label for="saveas">'.$tpl->l['SAVEAS'].'</label></p>';$h.='<p><input type="checkbox" name="pageto" id="pageto" value="1"'.((isset($alt['_']['pageto'])&&$alt['_']['pageto'])?' checked="checked"':'').' /><label for="pageto">'.$tpl->l['PAGETO'].'</label></p></td></tr>';if(isset($this->task[$alt['task']]['model2'])){$t=$this->task[$alt['task']]['model2'];if(is_string($t))$t=preg_split('/[\n,;]/',$t);$p=array();foreach($t as $k){if($k&&isset($m[$k])&&!in_array($k,array('published','enabled')))$p[$k]=$m[$k];}if($p){$h.='</table></div><div class="td_wra"><table class="form" id="prop">';$h.=vForm::draw($p,$d,($cfg['langs']>1&&$this->langs&&$this->trans)?$this->trans:'',$n,isset($d['ctype'])?$d['ctype']:'');}}$h.='</table></div></div></div></form>';$tpl->theme('body','',"@$h");}protected function edit_request(){global $alt,$cfg,$file,$ctype,$map,$blk;$m=&$this->model;$t=$this->task[$alt['task']]['model'];if(isset($this->task[$alt['task']]['model2'])&&$this->task[$alt['task']]['model2'])$t=array_merge($t,preg_split('/[\n,;]/',$this->task[$alt['task']]['model2']));$a=array();$p=0;foreach($t as $k){if($k&&isset($m[$k])&&!in_array($k,array('published','enabled','prop')))$a[$k]=($m[$k])?$m[$k]:'string';if($k=='prop')$p=1;}if(isset($m['meta'])&&isset($alt['module']['prop']['seo'])&&$alt['module']['prop']['seo'])$a['meta']='meta';$x=array();vRequest::vars($x,$a);if($p){if(isset($alt['module']['prop']))$p=$alt['module']['prop'];else if(isset($x['ctype'])&&$x['ctype']&&$ctype->r[$x['ctype']])$p=$ctype->r[$x['ctype']]['prop'];$a=array();foreach($p as $k=>$v){if($k{0}=='~')$k=substr($k,1);switch($v){case is_array($v):$v='text';break;case 'size':$v='int';break;}$a[$k]=$v;}$x['prop']=vRequest::arr('prop',$a);}else if(isset($alt['module']['prop']['ext'])&&$alt['module']['prop']['ext']){$x['prop']=vRequest::arr('prop',vRegistry::parse($alt['module']['prop']['ext']));}$alt['_']['pageto']=vRequest::bool('pageto');$alt['_']['saveas']=vRequest::bool('saveas');if($alt['id']){$x['id']=$alt['id'];if($alt['_']['saveas']){if(isset($m['cid']))$x['cid']=$alt['module']['id'];if(isset($m['created']))$x['created']=$this->_datetime($m['created']);}}else{$x['id']=0;if(isset($m['cid']))$x['cid']=$alt['module']['id'];if(isset($m['ordering']))$x['ordering']=($this->table=='blocks')?0:65535;if(isset($m['created']))$x['created']=$this->_datetime($m['created']);}if(isset($m['modified']))$x['modified']=$this->_datetime($m['modified']);if(isset($m['enabled'])){$x['enabled']=vRequest::bool('enabled');$alt['_']['enabled']=$x['enabled'];}else if(isset($m['published'])){$x['published']=0;if(vRequest::bool('enabled')){$x['published']=vRequest::string('published');$x['published']=($x['published'])?vTime::timestamp($x['published']):time();$x['published']=$this->_datetime($m['published'],$x['published']);}$alt['_']['enabled']=$x['published'];}if($cfg['langs']>1&&$this->langs){if($this->trans){$a=array();foreach($cfg['language'] as $i=>$j){if($i<>$cfg['lang'])$a[]=$i.':array';}vRequest::vars($x['_'],$a);}else if(isset($m['lang']))$x['lang']=vRequest::cmd('lang');}foreach($m as $k=>$v){if(in_array($v,array('image','media','file'))){if($alt['_']['saveas'])unset($x[$k]);require_once(PATH_CORE.DS.'file.php');$k2=$k.'_uploader';if(isset($x[$k2])&&$x[$k2]&&$x[$k2]['tmp_name']){if($a=vFilter::file($x[$k2]['name'],$v)){if(strpos($cfg['file']['dir'],'}'))$cfg['file']['dir']=strtr($cfg['file']['dir'],array('{ID}'=>$alt['module']['id'],'{ALIAS}'=>(($alt['module']['alias']=='/')?'0':$alt['module']['alias']),'{M}'=>date('m'),'{Y}'=>date('y'),'{YY}'=>date('Y')));if($a=$file->upload($x[$k2]['tmp_name'],$cfg['file']['dir'].'/'.$a)){if(isset($x[$k])&&$x[$k])$file->delete($x[$k]);$x[$k]=$a;if(isset($alt['module']['prop'][$k.'_sz'])){$a=$alt['module']['prop'][$k.'_sz'];if($a[0]||$a[1])$file->resize($x[$k],$a[0],$a[1]);}}}}else if(vRequest::bool($k.'_remover')&&isset($x[$k])&&$x[$k]){$file->delete($x[$k]);$x[$k]='';}unset($x[$k2]);}else if(in_array($v,array('images','medias','files'))&&isset($x[$k])){if($alt['_']['saveas'])$x[$k]=array();require_once(PATH_CORE.DS.'file.php');$a=(array) vRequest::_var($k.'_remover');foreach($a as $i=>$f){if($f&&isset($x[$k][$i])&&$x[$k][$i]){$file->delete($x[$k][$i]);unset($x[$k][$i]);}}$x[$k]=trim(implode("\n",array_merge($x[$k],vRequest::arr($k.'_uploader'))));}else if(in_array($v,array('array','prop','meta','tree'))&&isset($x[$k])){if($v=='prop'&&$p){foreach($p as $a=>$b){if($b=='pages'&&$x[$k][$a]&&sizeof($x[$k][$a])==$map->c)$x[$k][$a]='';}}$x[$k]=vRegistry::ini($x[$k]);}else if(in_array($v,array('pages'))&&isset($x[$k])){if(sizeof($x[$k])==$map->c)$x[$k]='';else $x[$k]=implode(',',$x[$k]);}}if($cfg['langs']>1&&$this->langs&&$this->trans){foreach($this->trans as $k){if(in_array($m[$k],array('array','prop','meta','tree'))){foreach($cfg['language'] as $i=>$j){if($i<>$cfg['lang']&&isset($x['_'][$i][$k]))$x['_'][$i][$k]=vRegistry::ini($x['_'][$i][$k]);}}}}if(isset($x['alias'])){if($x['alias']==''&&isset($x['title']))$x['alias']=$x['title'];$x['alias']=vFilter::alias($x['alias']);}return $x;}protected function edit_submit($x){global $db,$cfg,$tpl,$alt,$stf;$m=&$this->model;$t=isset($this->task[$alt['task']]['null'])?$this->task[$alt['task']]['null']:null;if($t){$n=0;if(is_string($t))$t=preg_split('/[\n,;]/',$t);foreach($t as $k){if(!isset($x[$k])||!$x[$k]){$this->msg[0]=2;$n++;}}if($n)$this->msg[]=$tpl->l['ERR_NOTNULL'];}if(isset($m['alias'])){$s='SELECT id FROM #__'.$this->table.' WHERE alias="'.$x['alias'].'"'.((isset($x['id'])&&$x['id'])?' AND id<>'.$x['id']:'');if(!$db->query($s))trigger_error($db->error(),E_USER_ERROR);if($db->affected_rows()||$x['alias']==''){$this->msg[]=$tpl->l['ERR_DUP_ALIAS'];$this->msg[0]=2;}}if($this->msg[0])return 0;$r=array();if(isset($x['_'])){$r=$x['_'];unset($x['_']);}if(isset($x['id'])&&$x['id']&&!$alt['_']['saveas']){$s=$db->sql('UPDATE','#__'.$this->table,$x,'id='.$x['id']);$l='edit';}else{$x['id']=0;$s=$db->sql('INSERT','#__'.$this->table,$x);$l='create';}if(!$db->query($s))trigger_error($db->error(),E_USER_ERROR);if(!isset($x['id'])||$x['id']==0)$x['id']=$db->nextid();if($r&&$cfg['langs']>1&&$this->langs&&$this->trans){foreach($cfg['language'] as $i=>$j){if($i<>$cfg['lang']&&isset($r[$i])){$s='SELECT id FROM #__'.$this->table.'_trans WHERE lang="'.$i.'" AND id='.$x['id'];if(!$db->query($s))trigger_error($db->error(),E_USER_ERROR);if($db->affected_rows())$s=$db->sql('UPDATE','#__'.$this->table.'_trans',$r[$i],'lang="'.$i.'" AND id='.$x['id']);else{$r[$i]['lang']=$i;$r[$i]['id']=$x['id'];$s=$db->sql('INSERT','#__'.$this->table.'_trans',$r[$i]);}if(!$db->query($s))trigger_error($db->error(),E_USER_ERROR);}}}if($cfg['log'])$stf->logs($alt['page'],$l,array('id'=>$x['id'],));return 1;}protected function resync(){$m=&$this->model;$d=$this->resync_data();$e=array();for($i=0,$n=count($d);$i<$n;$i++)$e[$d[$i]['id']]=&$d[$i];if(isset($m['count']))$this->resync_count($d);if(isset($m['tree']))$this->resync_tree($d,$e);else if(isset($m['ordering']))$this->resync_order($d);$this->resync_submit($d);if($this->table=='sitemap'){global $map;$map->load();}$this->ret=1;}protected function resync_data(){global $db;$m=&$this->model;$s='id';foreach(array('ctype','pid','ordering')as $k)if(isset($m[$k]))$s.=','.$k;$s='SELECT '.$s.' FROM #__'.$this->table.(isset($m['ordering'])?' ORDER BY ordering ASC, id ASC':'');if(!$db->query($s))trigger_error($db->error(),E_USER_ERROR);return $db->fetch();}protected function resync_count(&$d){global $ctype,$db;for($i=0,$n=count($d);$i<$n;$i++){$d[$i]['count']=0;if($d[$i]['ctype']&&$ctype->r[$d[$i]['ctype']]['func']){$s='SELECT count(*) AS counter FROM #__'.$ctype->r[$d[$i]['ctype']]['name'].' WHERE cid='.$d[$i]['id'];if($db->query($s))$d[$i]['count']=$db->fetch_field('counter');}}}protected function resync_order(&$d){for($i=0,$n=count($d);$i<$n;$i++)$d[$i]['ordering']=$i+1;}protected function resync_tree_loop(&$d,&$e,$id,$s,$l,$p=''){$t='';for($i=0,$n=count($d);$i<$n;$i++){if($id==$d[$i]['pid']){if(isset($d[$i]['ordering']))$d[$i]['ordering']=$s;$d[$i]['tree']['l']=$l;$t=$p;$d[$i]['tree']['f']='';$d[$i]['tree']['c']='';if($d[$i]['pid']){$e[$d[$i]['pid']]['tree']['c'].=(($e[$d[$i]['pid']]['tree']['c'])?',':'').$d[$i]['id'];$p.=(($p)?',':'').$d[$i]['pid'];}$d[$i]['tree']['p']=$p;$s=$this->resync_tree_loop($d,$e,$d[$i]['id'],$s+1,$l+1,$p);$p=$t;}}return $s;}protected function resync_tree(&$d,&$e){$this->resync_tree_loop($d,$e,0,1,0);$m=0;$n=count($d);for($i=0;$i<$n;$i++)$m=($d[$i]['tree']['l']>$m)?$d[$i]['tree']['l']:$m;for($j=$m;$j>0;$j--){for($i=0;$i<$n;$i++){if($d[$i]['tree']['l']==$j){$e[$d[$i]['pid']]['tree']['f'].=(($e[$d[$i]['pid']]['tree']['f'])?',':'').$d[$i]['id'];$e[$d[$i]['pid']]['tree']['f'].=(($e[$d[$i]['pid']]['tree']['f']&&$d[$i]['tree']['f'])?',':'').$d[$i]['tree']['f'];}}}}protected function resync_submit($d){global $db;$m=&$this->model;foreach($d as $k=>$v){if(isset($m['tree'])&&isset($v['tree']))$v['tree']=vRegistry::ini($v['tree']);$s=$db->sql('UPDATE','#__'.$this->table,$v,'id='.$v['id']);if(!$db->query($s))trigger_error($db->error(),E_USER_ERROR);}}function prop(){global $tpl,$ctype;$c=vRequest::cmd('ctype');if($c&&$c<>'null'&&isset($ctype->r[$c]))echo vForm::draw($ctype->r[$c]['prop'],'','',null,$c,'prop');die;}protected function _datetime($s,$t=0){if(!$t)$t=time();$d=0;switch($s){case 'int':$d=$t;break;case 'date':$d=date('Y-m-d',$t);break;case 'datetime':$d=date('Y-m-d H:i:s',$t);break;}return $d;}}?>