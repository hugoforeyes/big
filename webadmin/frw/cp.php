<?php
/**
* @version		$Id: cp.php 3 2013-12-30 14:56 phu $
* @package		vFramework.cp
* @copyright	(C) 2011 Vipcom. All rights reserved.
* @license		Commercial
*/
defined('V_LIFE')or die('v');include PATH_CORE.DS.'bootstrap.php';include PATH_CORE.DS.'string.php';$alt['id']=vRequest::int(VAR_ID);$alt['page']=vRequest::string(VAR_PAGE,'cp.welcome');$alt['section']=vRequest::string(VAR_SECTION);$alt['task']=vRequest::cmd(VAR_TASK);$alt['action']=vRequest::cmd(VAR_ACTION);$alt['return']=vRequest::string(VAR_RETURN);$alt['keyword']=str_replace(array('"',"'"),'',vRequest::string(VAR_KEYWORD));$alt['paging']=vRequest::int(VAR_PAGING,1);if($alt['paging']<1)$alt['paging']=1;$alt['publish']=vRequest::int(VAR_PUBLISH);$alt['lang']=vRequest::cmd(VAR_LANG);$alt['hot']=vRequest::int('hot');$alt['filter']=vRequest::arr('filter');$stf=vStaff::instance();if($alt['task']<>'login'&&$alt['task']<>'logout'&&$alt['task']<>'captcha'&&$stf->state<>'active'){$alt['page']='cp.staff';$alt['section']='';$alt['task']='login';}if($alt['page']=='cp.staff'&&$alt['task']=='keepalive')vPage::finish(date('r'));if(V_LIFE==2&&!defined('V_SITE')){define('V_SITE',isset($_SESSION['_vSite'])?intval($_SESSION['_vSite']):0);$db->query('SELECT prop FROM #__site WHERE id="'.V_SITE.'"',1);if($db->affected_rows()){$t=$db->fetch_field('prop');$t=($t)?vRegistry::parse($t):array();$cfg=array_merge($cfg,$t);}}define('URL_THEME',URL_THEMES.$cfg['theme'].'/');define('PATH_THEME',PATH_THEMES.DS.$cfg['theme']);$tpl=vTemplate::instance();$map=new vSitemap();$ctype=new vCType();if(isset($stf->profile['lang'])&&$stf->profile['lang'])$cfg['cp']['lang']=$stf->profile['lang'];define('PATH_CP_LANG',PATH_CP_LANGS.DS.$cfg['cp']['lang']);$tpl->lang('general');$tpl->lang('ctype');$tpl->vars(array('URL_CP'=>URL_CP,'URL_UPLOAD'=>URL_UPLOAD,'URL_THEME'=>URL_THEME,'URL_CP_THEME'=>URL_CP_THEME,'URL_JS'=>URL_JS,'NOTNULL'=>'<span class="ico inn" title="'.$tpl->l['NOTNULL'].'"></span>',));define('ICON_UP','<span class="ico iup" title="'.$tpl->l['UP'].'"></span>');define('ICON_DOWN','<span class="ico idown" title="'.$tpl->l['DOWN'].'"></span>');define('ICON_EDIT','<span class="ico iedit" title="'.$tpl->l['EDIT'].'"></span>');define('ICON_DEL','<span class="ico idel" title="'.$tpl->l['DELETE'].'"></span>');define('ICON_VIEW','<span class="ico iview" title="'.$tpl->l['VIEW'].'"></span>');define('ICON_POSTS','<span class="ico iposts" title="'.$tpl->l['POSTS'].'"></span>');define('ICON_AUTH','<span class="ico iauth" title="'.$tpl->l['AUTHORISE'].'"></span>');define('ICON_HOT','<span class="ico ihot" title="'.$tpl->l['HOT'].'"></span>');define('ICON_PIC','<span class="ico ipic" title="'.$tpl->l['PIC_THUMB'].'"></span>');define('ICON_SAVE','<span class="ico isave" title="'.$tpl->l['UPDATE'].'"></span>');define('ICON_DEV','<span class="ico idev" title=""></span>');define('ICON_RESET','<span class="ico ireset" title="'.$tpl->l['RESET'].'"></span>');define('ICON_MANAGE','<span class="ico iman" title="'.$tpl->l['MANAGE'].'"></span>');if(isset($cfg['~ajax'])===false){vPage::head(URL_CP_THEME.$cfg['cp']['theme_style'].'.css','css');}if(substr($alt['page'],0,3)=='cp.'){$t=substr($alt['page'],3);define('PATH_WORKING',PATH_CP_CTYPE.DS.$t);$cfg['path_working']=PATH_CP_CTYPE.DS.$t;$t=PATH_WORKING.DS.$t.'.php';if(is_file($t))require($t);else vPage::redirect(VAR_INDEX.'?'.VAR_PAGE.'=cp.sitemap');}else if(isset($map->r[$alt['page']]['ctype'])&&$map->r[$alt['page']]['ctype']!='alias'){$t=$map->r[$alt['page']]['ctype'];define('PATH_WORKING',PATH_CP_CTYPE.DS.$t);$cfg['path_working']=PATH_CP_CTYPE.DS.$t;$t=PATH_CP_CTYPE.DS.$t.DS.$t.'.php';if(is_file($t))require($t);else vPage::redirect(VAR_INDEX.'?'.VAR_PAGE.'=cp.sitemap');}else{cpPage::warning($tpl->l['ERR_ACCESS_DENIED']);}if(isset($cfg['~ajax'])===false){$tpl->root(PATH_CP_THEMES,$cfg['cp']['theme']);$tpl->vars(array('MENU'=>(vRequest::issubmit('quickview')||($alt['page']=='cp.staff'&&$alt['task']=='login'))?'':cpPage::menu(),'CTN'=>$tpl->display('body',true)));$tpl->theme('page','page');$tpl->display('page');}vPage::finish();
class cpPage{private static $_d=array();static function cmd($n,$u=''){global $tpl,$cfg,$stf;if($n&&(!isset($stf->{$n})||$stf->{$n})){list($i,$n)=explode(':',$n.':');if($n=='')$n=$i;if($u===false)$u='javascript:;';else if($u=='')$u='javascript:cmd(\''.$n.'\');';$html='<a class="'.$i.'" href="'.$u.'"><span></span>'.$tpl->_($n).'</a>';$tpl->_var('CMD',$html,true);if($n=='imexport')cpPage::help('import-export');}}static function nav($title,$url=''){global $tpl;$title=isset($tpl->l[strtoupper($title)])?$tpl->l[strtoupper($title)]:$title;$nav=($url)?'<a class="nav" href="'.$url.'">'.$title.'</a>':'<span class="nav">'.$title.'</span>';$tpl->_var('NAV',$nav,true);return true;}static function editor(){global $tpl,$stf,$stf;include_once(PATH_CP_CTYPE.DS.'editor'.DS.'editor.php');$stf->keepalive();}static function count($n){global $tpl;$tpl->_var('COUNT',$n);}static function error($s){global $tpl;$tpl->_var('MSG','<div class="error">'.((isset($tpl->l[$s]))?$tpl->l[$s]:$s).'</div>');}static function report($s){global $tpl;$tpl->_var('MSG','<div class="report">'.((isset($tpl->l[$s]))?$tpl->l[$s]:$s).'</div>');}static function warning($s){global $tpl;$tpl->_var('MSG','<div class="warning">'.((isset($tpl->l[$s]))?$tpl->l[$s]:$s).'</div>');}static function html($s){global $tpl;$tpl->_var('HTML',$s);}static function null(){vPage::redirect(VAR_INDEX.'?'.VAR_PAGE.'=null');}static function filter($name='search',$d='',$key=true){global $tpl,$cfg,$alt;$html='';switch($name){case 'search':$html='<span title="'.$tpl->l['SEARCH'].'"><input class="search" type="text" name="'.VAR_KEYWORD.'" value="'.$alt['keyword'].'" /><input class="search_btn" type="submit" name="s1" value="Submit" /></span>';break;case 'publish':$html='<select name="'.VAR_PUBLISH.'" onchange="this.form.submit();"><option value="0">'.$tpl->l['ENABLED'].' + '.$tpl->l['DISABLED'].'</option><option value="1"'.(($alt['publish']==1)?' selected="selected"':'').'>'.$tpl->l['ENABLED'].'</option><option value="2"'.(($alt['publish']==2)?' selected="selected"':'').'>'.$tpl->l['DISABLED'].'</option></select>';break;case 'language_all':case 'language':if($cfg['langs']>1){$html='<select name="'.VAR_LANG.'" onchange="this.form.submit();">';$html.=($name=='language_all')?'<option value="">- '.$tpl->l['ALL_LANG'].' -</option>':'';foreach($cfg['language'] as $k=>$v){$html.='<option value="'.$k.'"'.(($k==$alt['lang'])?' selected="selected"':'').'>'.$v['1'].'</option>';}$html.='</select>';}break;case 'display':$f=vRequest::int('display');$html='<select name="filter[display]" onchange="this.form.submit();"><option value="0">'.$tpl->l['NORMAL'].'</option><option value="1"'.(($f)?' selected="selected"':'').'>'.$tpl->l['FULL'].'</option></select>';break;default:if($d){$f=isset($alt['filter'][$name])?$alt['filter'][$name]:null;$html='<select name="filter['.$name.']" onchange="this.form.submit();">';$html.='<option value="">- '.((isset($tpl->l['ALL_'.strtoupper($name)]))?$tpl->l['ALL_'.strtoupper($name)]:$tpl->l['ALL']).' -</option>';foreach($d as $k=>$t){if($key===true)$k=$t;$extra=($f==$k)?' selected="selected"':'';$html.='<option value="'.$k.'" '.$extra.'>'.$t.'</option>';}$html.='</select>';}break;}$tpl->_var('FILTER',$html,true);}static function menu(){global $tpl,$map,$ctype,$db,$alt,$cfg,$stf;$t='<li{SUB}><a{URL}>{TITLE}</a>';$m=array();if(V_CP<3){if(V_LIFE==2){$m[]=array(0,$tpl->_('Site'),'=cp.site',1);$sql='SELECT id, title FROM #__site WHERE id>'.(V_SITE-10).' AND id<'.(V_SITE+10).' ORDER BY id ASC';if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);if($j=$db->affected_rows()){$p=$db->fetch();for($i=0;$i<$j;$i++)$m[]=array(1,$p[$i]['title'],(V_SITE==$p[$i]['id'])?'':'=cp.site&id='.$p[$i]['id']);}}$m[]=array(0,$tpl->_('Sitemap'),'=cp.sitemap',2);for($i=0;$i<$map->c;$i++){$m[]=array($map->d[$i]['tree']['l'] + 1,$map->d[$i]['title'],((isset($ctype->r[0][$map->d[$i]['ctype']])&&$ctype->r[0][$map->d[$i]['ctype']]['func'])?'='.$map->d[$i]['alias']:''));}$m[]=array(0,$tpl->_('Blocks'),'=cp.blocks',3);}if(V_CP>1){$sql='SELECT name, prop FROM #__ctype WHERE func=1 AND ctype=3 AND enabled=1 ORDER BY name ASC';if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);if($j=$db->affected_rows()){$m[]=array(0,$tpl->l['MANAGE'],'=cp.manage',4);$p=$db->fetch();for($i=0;$i<$j;$i++){$m[]=array(1,$tpl->_($p[$i]['name']),'=cp.'.$p[$i]['name']);if($p[$i]['prop']){$p[$i]['prop']=vRegistry::parse($p[$i]['prop']);foreach($p[$i]['prop'] as $k=>$v){$m[]=array(2,$tpl->_($k),'=cp.'.(is_array($v)?$v[0]:$v));}}}}}$m[]=array(0,$tpl->_('SYSTEM'),'=cp.site&'.VAR_SECTION.'=plugin',5);$m[]=array(1,$tpl->_((isset($_COOKIE['webadmin'])&&$_COOKIE['webadmin'])?'V_VISUAL_OFF':'V_VISUAL'),'=cp.staff&'.VAR_TASK.'=visual');$sql='SELECT name, prop FROM #__ctype WHERE func=1 AND ctype=2 AND enabled=1 ORDER BY name ASC';if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);if($j=$db->affected_rows()){$p=$db->fetch();for($i=0;$i<$j;$i++){$m[]=array(1,$tpl->_($p[$i]['name']),'=cp.'.$p[$i]['name']);if($p[$i]['prop']){$p[$i]['prop']=vRegistry::parse($p[$i]['prop']);foreach($p[$i]['prop'] as $k=>$v){$m[]=array(2,$tpl->_($k),'=cp.'.(is_array($v)?$v[0]:$v));}}}}$i=($cfg['cp']['lang']=='vn')?URL_HELP:URL_HELP_EN;$m[]=array(0,$tpl->_('HELP'),$i,6);$m[]=array(1,$tpl->_('HLP_GENERAL'),$i.'webadmin.html');foreach(cpPage::help()as $k=>$v){$m[]=array(1,$v,$i.$k.'.html');}$m[]=array(0,$tpl->l['LOGOUT'],'=cp.staff&'.VAR_TASK.'=logout',7);$m[]=array(1,$tpl->l['LOGOUT'].' :: <i>'.$stf->profile['username'].'</i>','=cp.staff&'.VAR_TASK.'=logout');$m[]=array(1,$tpl->_('GO_FRONTEND'),URL_BASE);$d='<ul id="menu">';$b=array();$c=sizeof($m);$i=0;$l=0;while($i<$c){if($m[$i][0]>$l){$d.="\n<ul>";$b[]="\n</ul>";}else if($m[$i][0]<$l){for($j=0,$k=($l-$m[$i][0])*2;$j<=$k;$j++){$d.=array_pop($b);}}else{$d.=array_pop($b);}$f=array('{TITLE}'=>$m[$i][1],'{URL}'=>($m[$i][2])?' href="'.(($m[$i][2]{0}=='/'||substr($m[$i][2],0,7)=='http://')?$m[$i][2].'" target="_blank':VAR_INDEX.'?'.VAR_LANG.'='.$alt['lang'].'&'.VAR_PAGE.$m[$i][2]).'"':' class="none"','{SUB}'=>((isset($m[$i+1])&&$m[$i+1][0]>$m[$i][0])?' class="sub"':'').((!$m[$i][0])?' id="menu'.$m[$i][3].'"':''),);$d.="\n".strtr($t,$f);$l=$m[$i][0];$b[]='</li>';$i++;}while($b){$d.=array_pop($b);}$d.='</ul>';return str_replace(array('&amp;','&'),array('&','&amp;'),$d);}static function help($e=''){if($e){global $tpl;$k='HLP_'.strtoupper($e);if(isset($tpl->l[$k]))self::$_d[$e]=$tpl->l[$k];}else{return self::$_d;}}static function blank($l){$h='';while($l>0){$h.='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';$l--;}return $h;}static function form($name,$attribs=null,$selected=NULL,$idtag=false,$all=false){global $cfg,$tpl;$html='';switch($name){case 'lang':case 'language':if($cfg['langs']>1){$id=($idtag)?$idtag:$name;$html='<select name="'.$name.'" id="'.$id.'" '.$attribs.'>';if($all)$html.='<option value="">'.$tpl->l['ALL_LANG'].'</option>';foreach($cfg['language'] as $k=>$v)$html.='<option value="'.$k.'"'.(($k==$selected)?' selected="selected"':'').'>'.$v['1'].'</option>';$html.='</select>';}break;}return $html;}static function prop($p,$d='',$c=''){global $tpl,$db,$map;$html='';if($p){if(!is_array($p))$p=explode("\n",$p);foreach($p as $k=>$v){if(is_int($k)){$t=explode(':',$v.':');$k=$t[0];$v=$t[1];}if(empty($v))$v='string';if($k){$t=strtoupper($k);$html.='<tr><th>';if($v=='html'||$t=='CSS'||$t=='SUB')$html.=ICON_DEV;$html.=(isset($tpl->l['PROP_'.$t])?$tpl->l['PROP_'.$t]:$t).'</th><td>';switch($v){case is_array($v):if(isset($tpl->l[strtoupper('prop_'.$k.'_'.$v[0])])){$t=array();foreach($v as $b)$t[$b]=$tpl->_('prop_'.$k.'_'.$b);$html.=vForm::select($t,'prop_'.$k,'',null,null,(isset($d[$k])?$d[$k]:''));}else $html.=vForm::select($v,'prop_'.$k,'',true,null,(isset($d[$k])?$d[$k]:''));break;case 'bool':$html.=vForm::select(array($tpl->l['S_OFF'],$tpl->l['S_ON']),'prop_'.$k,'','',null,(isset($d[$k])?$d[$k]:0));break;case 'record':case 'records':if($c){$sql='SELECT id, title FROM #__'.$c;if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);$html.=vForm::select($db->fetch(),'prop_'.$k,'','id','title',(isset($d[$k])?$d[$k]:0));$html.=' <a class="cp-button" href="'.VAR_INDEX.'?'.VAR_PAGE.'=cp.'.$c.'">'.ICON_EDIT.'</a>';}break;case 'category':$sql='SELECT id, title FROM #__category WHERE section="'.substr($k,0,3).'" ORDER BY ordering';if(!$db->query($sql))trigger_error($db->error(),E_USER_ERROR);$html.=vForm::select(array_merge(array('0'=>array('id'=>0,'title'=>'')),$db->fetch()),'prop_'.$k,'','id','title',(isset($d[$k])?$d[$k]:0));$html.=' <a class="cp-button" href="'.VAR_INDEX.'?'.VAR_PAGE.'=cp.category&amp;'.VAR_SECTION.'='.$k.'&amp;'.VAR_RETURN.'='.$c.'">'.ICON_EDIT.'</a>';break;case 'page':$html.=vForm::select($map->select(),'prop_'.$k,'','','',(isset($d[$k])?$d[$k]:0));break;case 'pages':$html.=vForm::select($map->select(),'prop_'.$k.'[]','class="multiselect" size="10" multiple="multiple"','','',(isset($d[$k])?$d[$k]:0),'prop_'.$k);break;case 'text':case 'html':$html.='<textarea name="prop_'.$k.'" class="editor-'.(($v=='html')?'tiny':'text').'">'.(isset($d[$k])?$d[$k]:'').'</textarea>';break;case 'file':default:$html.='<input type="text" name="prop_'.$k.'" value="'.(isset($d[$k])?$d[$k]:'').'" class="prop_'.$v.'">';}$html.='</td></tr>';}}}return $html;}static function get_prop($p){global $tpl,$map;$d=array();if($p){if(!is_array($p))$p=explode("\n",$p);foreach($p as $k=>$v){if(is_int($k)){$t=explode(':',$v.':');$k=$t[0];$v=$t[1];}if(empty($v))$v='string';if($k){if($v=='int')$d[$k]=vRequest::int('prop_'.$k);else if($v=='bool')$d[$k]=vRequest::bool('prop_'.$k);else if($v=='string')$d[$k]=vRequest::string('prop_'.$k);else if($v=='text'||$v=='html')$d[$k]=vRequest::html('prop_'.$k);else if($v=='record')$d[$k]=vRequest::int('prop_'.$k);else if($v=='records')$d[$k]=vRequest::_var('prop_'.$k);else if($v=='page')$d[$k]=vRequest::int('prop_'.$k);else if($v=='pages'){$d[$k]=vRequest::_var('prop_'.$k);if(is_array($d[$k])&&sizeof($d[$k])==$map->c)$d[$k]='';}else $d[$k]=vRequest::cmd('prop_'.$k);}}}return $d;}}?>