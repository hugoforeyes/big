<?php
/**
* @version		$Id: fileman.php 1 2011-12-29 10:38 phu $
* @package		vFramework.cp.fileman
* @copyright	(C) 2011 Vipcom. All rights reserved.
* @license		Commercial
*/
defined('V_LIFE')or die('v');require_once(PATH_CORE.DS.'file.php');$fs=array(" B"," KB"," MB"," GB"," TB"," PB"," EB"," ZB"," YB");header("Expires: Mon, 26 Jul 1997 05:00:00 GMT");header("Last-Modified: ".gmdate("D, d M Y H:i:s")." GMT");header("Cache-Control: no-store, no-cache, must-revalidate");header("Cache-Control: post-check=0, pre-check=0",false);header("Pragma: no-cache");$alt['opener']=vRequest::cmd('opener');$alt['folder']=str_replace(array('../','./'),'',vRequest::string('folder'));$url=VAR_INDEX.'?'.VAR_PAGE.'='.$alt['page'].((vRequest::issubmit('quickview'))?'&quickview':'').'&opener='.$alt['opener'];cpPage::nav('FILEMAN',VAR_INDEX.'?'.VAR_PAGE.'='.$alt['page']);vPage::head($tpl->_('Fileman'),'title');switch($alt['task']){case 'upload':$cfg['~ajax']=1;($stf->publish)?fm_upload():die($tpl->l['ERR_ACCESS_DENIED']);break;case 'mkdir':$cfg['~ajax']=1;($stf->publish)?fm_mkdir():die($tpl->l['ERR_ACCESS_DENIED']);break;case 'rmdir':$cfg['~ajax']=1;($stf->publish)?fm_rmdir():die($tpl->l['ERR_ACCESS_DENIED']);break;case 'rendir':$cfg['~ajax']=1;($stf->publish)?fm_rendir():die($tpl->l['ERR_ACCESS_DENIED']);break;case 'renfile':$cfg['~ajax']=1;($stf->publish)?fm_renfile():die($tpl->l['ERR_ACCESS_DENIED']);break;case 'size':$cfg['~ajax']=1;($stf->publish)?fm_size():die($tpl->l['ERR_ACCESS_DENIED']);break;case 'edit':$cfg['~ajax']=1;($stf->publish)?fm_edit():die($tpl->l['ERR_ACCESS_DENIED']);break;case 'del':($stf->delete)?fm_delete():cpPage::null();break;case 'thumb':$cfg['~ajax']=1;fm_thumb();break;case 'stat':$cfg['~ajax']=1;fm_stat();break;case 'list':case 'expand':case 'expand_list':$cfg['~ajax']=1;fm_expand();break;}if($alt['opener']=='editor')$tpl->block('editor',array());if($alt['opener']=='plugin')$tpl->block('plugin',array());$u=URL_UPLOAD;if(substr($u,0,7)!='http://'){$t=parse_url(vRequest::site());$u=$t['scheme'].'://'.$t['host'].$u;}$tpl->vars(array('U_UPLOAD'=>$u,'U_FILEMAN'=>$url.'&'.VAR_TASK.'=','LST_EXT'=>implode(',',array($cfg['file']['image'],$cfg['file']['media'],$cfg['file']['ext'])),'MAX_SIZE'=>(isset($cfg['file']['size'])?intval($cfg['file']['size'])/1048576:1).'mb','CHUNK_SIZE'=>(isset($cfg['file']['chunk'])?intval($cfg['file']['chunk'])/1048576:1).'mb',));$tpl->root(PATH_WORKING);$tpl->theme('body','fileman');function fm_thumb(){global $file;$f=vRequest::string('filename');$e=$file->ext($f);if($e=='png')$s=imagecreatefrompng(PATH_UPLOAD.DS.$f);else if($e=='gif')$s=imagecreatefromgif(PATH_UPLOAD.DS.$f);else{$e='jpeg';$s=imagecreatefromjpeg(PATH_UPLOAD.DS.$f);}if($s){$x=imageSX($s);$y=imageSY($s);if($x>90||$y>90){if($x>$y){$w=90;$h=$y*90/$x;}else{$h=90;$w=$x*90/$y;}$d=ImageCreateTrueColor($w,$h);imagecopyresampled($d,$s,0,0,0,0,$w,$h,$x,$y);header('Content-Type: image/'.$e);if($e=='png')imagepng($d);if($e=='gif')imagegif($d);else imagejpeg($d);imagedestroy($s);imagedestroy($d);die;}imagedestroy($s);vPage::redirect(URL_UPLOAD.$f);}}function fm_delete(){global $file,$alt;$f=vRequest::arr('filename');if($f){if(!is_array($f))$f[]=$f;foreach($f as $a)if(!$file->delete($alt['folder'].$a))die('{"jsonrpc" : "2.0", "error" : {"code": 102, "message": "Can not delete file '.$a.'!"}}');die('{"jsonrpc" : "2.0", "result" : "1"}');}}function fm_rmdir(){global $file,$alt;if($alt['folder']&&$file->rmdir($alt['folder']))die('{"jsonrpc" : "2.0", "result" : "1"}');die('{"jsonrpc" : "2.0", "error" : {"code": 102, "message": "Can not remove folder!"}}');}function fm_mkdir(){global $file,$alt;$f=vFilter::folder(vRequest::string('newfolder'));if($f&&$file->mkdir($alt['folder'].$f,'0777'))die('{"jsonrpc" : "2.0", "result" : "'.$f.'"}');die('{"jsonrpc" : "2.0", "error" : {"code": 102, "message": "Can not create folder!"}}');}function fm_rendir(){global $file,$alt;$f=vFilter::folder(vRequest::string('newfolder'));if($f&&$file->rename($alt['folder'],$f))die('{"jsonrpc" : "2.0", "result" : "'.$f.'"}');die('{"jsonrpc" : "2.0", "error" : {"code": 102, "message": "Can not rename folder!"}}');}function fm_renfile(){global $file,$alt;$f=vFilter::file(vRequest::string('filename'));$n=vFilter::file(vRequest::string('newfilename').'.'.$file->ext($f));if($f&&$n&&$file->rename($alt['folder'].$f,$n))die('{"jsonrpc" : "2.0", "result" : "'.$n.'"}');die('{"jsonrpc" : "2.0", "error" : {"code": 102, "message": "Can not rename file!"}}');}function fm_size(){global $file,$alt;if($f=vFilter::file(vRequest::string('filename'))){if($t=@getimagesize(PATH_UPLOAD.DS.$alt['folder'].$f)){$w=$t[0];$h=$t[1];$x=vRequest::int('width');$y=vRequest::int('height');if(($x||$y)&&($x<$w||$y<$h)){if($x==0){$w=$w*$y/$h;$h=$y;}else if($y==0){$h=$h*$x/$w;$w=$x;}else{$i=$x/$w;$j=$y/$h;if($i>$j)$i=$j;$w=$w*$i;$h=$h*$i;}}die('{"jsonrpc" : "2.0", "result" : ['.intval($w).', '.intval($h).']}');}}die('{"jsonrpc" : "2.0", "error" : {"code": 102, "message": "Can not get file size!"}}');}function fm_edit(){global $file,$alt;if($f=vFilter::file(vRequest::string('filename'))){$e=$file->ext($f);if($e=='png')$s=imagecreatefrompng(PATH_UPLOAD.DS.$alt['folder'].$f);else if($e=='gif')$s=imagecreatefromgif(PATH_UPLOAD.DS.$alt['folder'].$f);else{$e='jpeg';$s=imagecreatefromjpeg(PATH_UPLOAD.DS.$alt['folder'].$f);}if($s){$x=imageSX($s);$y=imageSY($s);if($a=vRequest::string('action')){foreach(explode(';',$a)as $t){if($t){$t=explode(',',$t);switch($t[0]){case 'resize':$w=intval($t[1]);$h=intval($t[2]);if($w&&$h){$d=ImageCreateTrueColor($w,$h);imagecopyresampled($d,$s,0,0,0,0,$w,$h,$x,$y);$x=$w;$y=$h;$s=$d;}break;case 'crop':$i=intval($t[1]);$j=intval($t[2]);$w=intval($t[3])- $i;$h=intval($t[4])- $j;if($w&&$h&&$w<=$x&&$h<=$y){$d2=ImageCreateTrueColor($w,$h);imagecopy($d2,$s,0,0,$i,$j,$w,$h);$x=$w;$y=$h;$s=$d2;}break;case 'fliph':$d2=ImageCreateTrueColor($x,$y);if(imagecopyresampled($d2,$s,0,0,$x-1,0,$x,$y,-$x,$y))$s=$d2;break;case 'flipv':$d2=ImageCreateTrueColor($x,$y);if(imagecopyresampled($d2,$s,0,0,0,$y-1,$x,$y,$x,-$y))$s=$d2;break;case 'ccw':$d=imagerotate($s,-90,0);$i=$y;$y=$x;$x=$i;$s=$d;break;case 'cw':$d=imagerotate($s,90,0);$i=$y;$y=$x;$x=$i;$s=$d;break;}}}if($n=vFilter::file(vRequest::string('newfilename'))){if(!vRequest::issubmit('overwrite')&&$file->exist($alt['folder'].$n))die('{"jsonrpc" : "2.0", "error" : {"code": 102, "message": "File exist!"}}');if($e=='png')imagepng($s,PATH_UPLOAD.DS.$alt['folder'].$n);if($e=='gif')imagegif($s,PATH_UPLOAD.DS.$alt['folder'].$n);else imagejpeg($s,PATH_UPLOAD.DS.$alt['folder'].$n);die('{"jsonrpc" : "2.0", "result" : "'.$n.'"}');}else{header('Content-Type: image/'.$e);if($e=='png')imagepng($s);if($e=='gif')imagegif($s);else imagejpeg($s);}imagedestroy($s);@imagedestroy($d);@imagedestroy($d2);die;}vPage::redirect(URL_UPLOAD.$f);}}die('{"jsonrpc" : "2.0", "error" : {"code": 102, "message": "Image not found!"}}');}function fm_upload(){global $alt,$file;$chunk=vRequest::int('chunk',0);$chunks=vRequest::int('chunks',0);$fileName=vRequest::string('name');if(isset($_SERVER["HTTP_CONTENT_TYPE"]))$contentType=$_SERVER["HTTP_CONTENT_TYPE"];if(isset($_SERVER["CONTENT_TYPE"]))$contentType=$_SERVER["CONTENT_TYPE"];$f=$file->upload((strpos($contentType,"multipart")!==false)?$_FILES['file']['tmp_name']:"php://input",$alt['folder'].$fileName,$chunks,$chunk);if($f)die('{"jsonrpc" : "2.0", "result" : "'.basename($f).'"}');else die('{"jsonrpc" : "2.0", "error" : {"code": 102, "message": "'.$file->error.'"}}');}function fm_stat(){global $file,$fs,$alt;if($f=vFilter::file(vRequest::string('filename'))){$t=$file->stat((($alt['folder'])?$alt['folder'].DS:'').$f);die('{"jsonrpc" : "2.0", "size" : "'.(($t['size'])?round($t['size']/pow(1024,($j=floor(log($t['size'],1024)))),($t['size']>1048576)?2:0).$fs[$j]:'0').'", "date" : "'.date("Y-m-d G:i",$t['date']).'"}');}die('{"jsonrpc" : "2.0", "error" : {"code": 102, "message": ""}}');}function fm_expand(){global $file,$alt,$fs;$d=&$alt['folder'];$h1='<ul class="fileTree" style="display: none;">';$h2='';$h3='';$h4='';$ls=$file->ls($d,($alt['action']=='detail')?2:1);foreach($ls as $i=>$f){if($file->error['folder'][$i]){$h1.='<li class="directory collapsed"><a href="javascript:void(0)" rel="'.htmlentities($d.$f).'/">'.htmlentities($f).'</a><i></i></li>';}else{$h2.=',"'.htmlentities($f).'"';if($alt['action']=='detail'){$a=$file->error['size'][$i];$h3.=',"'.(($a)?round($a/pow(1024,($j=floor(log($a,1024)))),($a>1048576)?2:0).$fs[$j]:'0').'"';$h4.=',"'.date("Y-m-d G:i",$file->error['date'][$i]).'"';}}}$h1.='</ul>';if($h2)$h2=substr($h2,1);if($h3)$h3=substr($h3,1);if($h4)$h4=substr($h4,1);die('{"jsonrpc" : "2.0"'.(($alt['task']=='list')?'':', "folder" : "'.str_replace('"','\"',$h1).'"').(($alt['task']=='expand')?'':', "file" : ['.$h2.']').(($alt['action']=='detail')?', "size" : ['.$h3.'], "date" : ['.$h4.']':'').'}');}?>